define("scopa/common/mapping",["./schema","./harts"],function(a){mining.mappingutils={get:function(b,c){if(mining.utils.isEmpty(mining.mapping)||c){b||mining.baseurl.console,m=a("./schema"),m.obj.objList.harts={label_name:"隐性关系",type_name:"隐性关系",label:"harts",element_type:"relation",timeline:"time_list",type:"",fields:"type"},$.each(m.obj.objList,function(a,b){var c={common:["primary_prop","minor_prop","fields","icon_prop","title","show","show_bigger","groupby","timeline"],entity:["key_prop","key_mapping","menu"],relation:["subject_label","object_label"],event:[]};$.each(c.common,function(a,c){b[c]||(b[c]="")}),$.each(c[b.element_type],function(a,c){b[c]||(b[c]="")});var d=[];mining.utils.isEmpty(b.minor_prop)?$.each(b.fields.split(","),function(a,c){-1==b.primary_prop.indexOf(c)&&d.push(c)}):$.each(b.minor_prop.split(","),function(a,c){-1==b.primary_prop.indexOf(c)&&d.push(c)}),b.minor_prop=d.join(",")});var d=a("./harts");if(mining.baseurl.harts&&$ajax.ajax({url:mining.baseurl.harts+"/mapping",async:!1,success:function(a){d.harts=a.rule},error:function(){seajs.log("呼叫园长：获取HartsMapping失败啦！")}}),d.harts){var e={},f={};$.each(d.harts,function(a,b){e["harts_"+b.id]=b}),$.each(d.eventmapping,function(a,b){f[a]=b}),$.extend(m.obj,{hartsMapping:e,hartsEventMapping:f})}$.each(m.obj.propertyMapping,function(a,b){""!=b.time_format&&(b.time_format=b.time_format.replace("yyyy","YYYY").replace("dd","DD"))});try{m.obj.propertyMapping.PERSON_zjhm.name="身份证号"}catch(g){}mining.utils.localStorage(mining.localname.mapping,m.obj),mining.mapping=m.obj}},getName:function(a){var b="";return mining.utils.isEmpty(a)||"object"!=typeof a||mining.utils.isEmpty(a.label)||(b=a.label+(mining.utils.isEmpty(a.type)?"":"_"+a.type)),b},getMapping:function(a){var b=void 0,c=function(a,b){return(-1!=a.indexOf("trafficmonitor_event")||-1!=a.indexOf("vehicle_event")||-1!=a.indexOf("vehicle_relation")||-1!=a.indexOf("criminalVehicle_relation"))&&(b=b.replace("big_vehicle","other").replace("small_vehicle","other")),b};"string"==typeof a?a=c(a,a):"object"==typeof a&&a.label&&a.type&&"string"==typeof a.label&&(a.type=c(a.label,a.type));try{var d="string"==typeof a?a:mining.mappingutils.getName(a);b=mining.mapping.objList[d]}catch(e){}return b},getType:function(a){var b="",c=mining.mappingutils.getMapping(a);if(!a)return"";if(b="string"!=typeof a||mining.utils.isEmpty(c)?mining.utils.isEmpty(a.element_type)?c?c.element_type:"":a.element_type:c.element_type,mining.utils.isEmpty(b)&&"string"==typeof a){var d=mining.mappingutils.getClassList();d.relation[a],$.each(d,function(c,d){return mining.utils.isEmpty(d[a])?void 0:(b=c,!1)})}return b},getLabelName:function(a){var b="";try{b=mining.mappingutils.getMapping(a).label_name}catch(c){}if(mining.utils.isEmpty(b)&&"string"==typeof a){var d=mining.mappingutils.getClassList();$.each(d,function(c,d){return mining.utils.isEmpty(d[a])?void 0:(b=d[a].label_name,!1)})}return b},getLabel:function(a){var b="",c="";try{var d=mining.mappingutils.getMapping(a);b=d.label,c=d.label_name}catch(e){if("string"==typeof a){var f=mining.mappingutils.getClassList();$.each(f,function(d,e){return mining.utils.isEmpty(e[a])?void 0:(b=e[a].label,c=e[a].label_name,!1)})}}return{name:b,value:c}},getTypeName:function(a){try{return mining.mappingutils.getMapping(a).type_name}catch(b){return""}},getFontName:function(a){try{var b=mining.mappingutils.getMapping(a),c="";if(b)c=b.icon_mapping;else{var d=mining.mappingutils.getClassList();$.each(d,function(b,d){return d[a]?(c=mining.mappingutils.getMapping(d[a].label+"_"+d[a].children[0].type).icon_mapping||"",!1):void 0})}return"graphicon "+c.substring(c.indexOf("-")+1,c.length)}catch(e){return""}},getTypeList:function(a){var b={};return a=a||"all",$.each(mining.mapping.objList,function(c,d){("all"==a||a==d.element_type)&&(b[c]=d.type_name)}),b},getLabels:function(a){var b=[];return a=a||"all",$.each(mining.mapping.objList,function(c,d){-1!=b.indexOf(d.label)||"all"!=a&&a!=d.element_type||b.push(d.label)}),b},getClassList:function(a){var b={entity:{},relation:{},event:{}};return $.each(mining.mapping.objList,function(a,c){var d=c.element_type;mining.utils.isEmpty(b[d][c.label])&&(b[d][c.label]={label:c.label,label_name:c.label_name,children:[]}),b[d][c.label].children.push({type:c.type,type_name:c.type_name})}),"all"!=a&&b[a]?b[a]:b},getProperties:function(a,b){var c,d,e=mining.mappingutils.getMapping(a),f=[],g=[],h=[],i=[],j={},k=function(b,d){if(c=mining.utils.clone(mining.mapping.propertyMapping[d])||{},j[b]=c,"string"==typeof a)j[b].value="";else if("label"==b||"type"==b)j[b].value=e[b+"_name"];else if(mining.utils.isEmpty(c.time_format))a[b]&&(j[b].value=a[b]);else{var f=!a[b]||-1!=a[b].indexOf("-")&&0!=a[b].indexOf("-")?a[b]:mining.utils.getUTCTime(parseInt(a[b]),c.time_format);j[b].value="Invalid date"==f?a[b]:f}try{j[b].value=j[b].value.trim()}catch(g){}mining.utils.isEmpty(j[b].value)&&"string"!=typeof a&&delete j[b]};if(mining.utils.isEmpty(e))return!mining.utils.isEmpty(a)&&mining.utils.isEmpty(a.label)&&$.each(a,function(a){"string"==typeof a&&k(a,a)}),j;if("key"==b)c=mining.utils.clone(mining.mapping.propertyMapping[e.key_prop])||{name:"",time_format:""},j.name=c.name,j.value="string"==typeof a?"":mining.utils.isEmpty(c.time_format)?a.key:mining.utils.getUTCTime(parseInt(a.key),c.time_format);else{switch(g=e.primary_prop.split(","),h=e.minor_prop.split(","),filesArr=e.fields.split(","),f=g.concat(h),b){case"primary":i=g;break;case"minor":i=h;break;case"fields":i=filesArr;break;default:i=f}$.each(i,function(a,b){d="key"!=b||mining.utils.isEmpty(e.key_prop)?b:e.key_prop,k(b,d)}),"minor"==b&&"object"==typeof a&&"custom"==a.specificType&&(a.owner&&(j.owner={data_type:"string",name:"添加人",time_format:"",value:a.owner}),a.lastModifyTime&&(j.lastModifyTime={data_type:"string",name:"添加时间",time_format:"",value:moment(parseInt(a.lastModifyTime)).format("YYYY-MM-DD HH:ss:mm")}),a.description&&(j.description={data_type:"string",name:"标注",time_format:"",value:a.description}))}return j},getPropLabel:function(a){return mining.mapping.propertyMapping[a]?mining.mapping.propertyMapping[a].name:""},getTitle:function(a){var b=mining.mappingutils.getMapping(a),c=[],d=[];return a.label&&"harts"==a.label?d.push(mining.mappingutils.getRuleLabel(a)):mining.utils.isEmpty(b)||mining.utils.isEmpty(b.title)||(c=b.title.split(","),$.each(c,function(c,e){var f=mining.mappingutils.formatProperty(mining.utils.newObj(e,a[e]))[e];f&&"string"==typeof f&&(("label"==e||"type"==e)&&(f=b[e+"_name"]),d.push(f))})),d.join("-")},getGroupBy:function(a){try{return mining.mappingutils.getMapping(a).groupby.split(",")}catch(b){return[]}},getShowlabel:function(a,b){b=b||"show_normal","show_normal"!=b&&(b="show_bigger");var c=[];if(a&&"harts"==a.label){mining.hartsrule||(mining.hartsrule=[{ids:[],name:"同住",count:0},{ids:[],name:"同行",count:0}],$.each(mining.mapping.hartsMapping,function(a,b){-1!=b.name.indexOf("同住")?mining.hartsrule[0].ids.push(b.id):-1!=b.name.indexOf("同行")?mining.hartsrule[1].ids.push(b.id):mining.hartsrule.push({ids:[b.id],name:b.name,count:0})})),$.each(mining.hartsrule,function(a,b){b.count=0});var d=a.frequencies?-1!=a.frequencies.indexOf(";")?a.frequencies.split(";"):a.frequencies.split(","):[];return mining.mappingutils.getRuleLabel(a),$.each(d,function(a,b){var c=b.split(":");$.each(mining.hartsrule,function(a,b){return-1!=b.ids.indexOf(parseInt(c[0]))?(b.count+=parseInt(c[1]),!1):void 0})}),$.each(mining.hartsrule,function(a,b){b.count>0&&c.push({name:b.name,value:b.name+":"+b.count+"次"})}),c}var e=mining.mappingutils.getMapping(a);return"event"==e.element_type&&(b="title"),mining.utils.isEmpty(e)||mining.utils.isEmpty(e[b])||$.each(e[b].split(","),function(b,d){var f=mining.mappingutils.formatProperty(mining.utils.newObj(d,a[d]))[d];mining.utils.isEmpty(f)||(("label"==d||"type"==d)&&(f=e[d+"_name"]),c.push({name:mining.mappingutils.getPropLabel(d),value:f}))}),c},getMenu:function(a){var b=null,c={entity:[],event:[]},b=mining.mappingutils.getMapping(a);return b&&b.menu&&!mining.utils.isEmpty(b.menu)&&$.each(b.menu.split(","),function(a,b){var d=mining.mappingutils.getType(b),e=mining.mappingutils.getLabelName(b);"relation"==d?c.entity.push({name:b,label:e}):"event"==d&&c.event.push({name:b,label:e})}),c},getGraphIcon:function(a,b){var c=mining.mappingutils.getMapping(a);if(iconname="",mining.utils.isEmpty(c)){if("doc"==a.label)return iconname="entity_document",staticUrl+"/scopa/images/core/"+iconname+".png";iconname="default"}else{if(b=b||"normal","smaller"==b)iconname=c.element_type;else{if("big"==b&&"person"==a.label&&!mining.utils.isEmpty(a.photoUrl))return a.photoUrl;iconname=c.icon_mapping}mining.utils.isEmpty(iconname)&&(iconname=c.element_type),"person"==c.label&&"女"==a.PERSON_xb&&(iconname+="_women")}return staticUrl+"/scopa/images/graphicon/"+iconname+".png"},getMapIcon:function(a,b){return mining.mappingutils.getGraphIcon(a,b)},formatProperty:function(a){var b=mining.utils.clone(a);return $.each(b,function(a,c){var d=mining.mapping.propertyMapping[a];if(d&&"string"==typeof c&&d)if(mining.utils.isEmpty(d.time_format))b[a]&&(b[a]=c.replace(" 00:00:00",""));else{var e="Invalid date"==moment(c).format()?parseInt(c):c;b[a]=mining.utils.getUTCTime(e,d.time_format)}}),b},setRuleIds:function(a){try{if("harts"==a.label&&""==a.rule_ids){var b=a.frequencies.split(";"),c=[];$.each(b,function(a,b){c.push(b.split(":")[0])}),a.rule_ids=c.join(";")}}catch(d){}return a},getRuleLabel:function(a){var b=[];return mining.mappingutils.setRuleIds(a),ruleIds=a.rule_ids?-1!=a.rule_ids.indexOf(";")?a.rule_ids.split(";"):a.rule_ids.split(","):[],$.each(ruleIds,function(a,c){var d=mining.mapping.hartsMapping["harts_"+c.trim()];d&&(b=b.concat(d.name))}),b},getRuleIds:function(){var a=[];return $.each(mining.mapping.hartsMapping,function(b,c){a.push(c.id)}),a},getHartEvents:function(a){mining.mappingutils.setRuleIds(a);var b=a.rule_ids?-1!=a.rule_ids.indexOf(";")?a.rule_ids.split(";"):a.rule_ids.split(","):[],c=[];$.each(b,function(a,b){var d=mining.mapping.hartsMapping["harts_"+b.trim()];d&&(c=c.concat(d.event))});var d=[];return $.each(c,function(a,b){d.pushOnly(b)}),d},getTimeProp:function(a){var b=mining.mappingutils.getMapping(a),c={key:"",name:"",value:""};try{c.key=b.timeline,c.name=mining.mappingutils.getPropLabel(c.key),c.value=mining.mappingutils.formatProperty(mining.utils.newObj(c.key,a[c.key]))[c.key]}catch(d){}return c},getHartsList:function(a){if(mining.utils.isEmpty(a))return mining.mapping.hartsMapping;mining.mappingutils.setRuleIds(a);var b=a.rule_ids?a.rule_ids.split(";"):[],c=[];return $.each(b,function(b,d){var e="harts_"+d.trim(),f=mining.mapping.hartsMapping[e];f&&c.push($.extend(f,{gid:a.gid,label:e}))}),c},getHartsTimeList:function(a){var b=a.time_list?a.time_list.split(";"):[],c=[];return $.each(b,function(b,d){var e=d.substring(0,d.indexOf(":")),f=d.substring(d.indexOf(":")+1,d.length);if(!mining.utils.isEmpty(f)&&-1==f.indexOf("*")){var g="harts_"+e,h=mining.mapping.hartsMapping[g];h&&c.push($.extend(h,{gid:a.gid,label:g,time:f.split(",")}))}}),c},getTimeList:function(a){var b="string"==typeof a?a:mining.mappingutils.getName(a),c=mining.mappingutils.getMapping(b),d=[];if(c)if("harts"==c.label)d=mining.mappingutils.getHartsTimeList(a);else{var e=a.specialtime;mining.utils.isEmpty(e)&&!mining.utils.isEmpty(c.timeline)&&(e=a[c.timeline]);try{if(!mining.utils.isEmpty(e)&&-1==e.indexOf("*")){var f=e.split(",");$.each(f,function(a,b){var c=parseInt(b),d=26496e5;(d>c||"Invalid Date"==new Date(c))&&f.remove(b)}),mining.utils.isEmpty(f)||d.push({gid:a.gid,label:b,name:c.type_name,time:f})}}catch(g){}}return d},getGeoEntity:function(){if(mining.mapping.geo&&mining.mapping.geo.geoEntity)return mining.mapping.geo.geoEntity;var a=mining.mapping.propertyMapping,b=mining.mappingutils.getTypeList("entity"),c=[],d={};return $.each(a,function(a,b){"geo"==b.data_type&&c.push(a)}),$.each(b,function(a){var b=mining.mapping.objList[a].fields.split(",");$.each(c,function(c,e){return-1!=b.indexOf(e)?(d[mining.mapping.objList[a].label]=mining.mapping.objList[a].label_name,!1):void 0})}),mining.mapping.geo||(mining.mapping.geo={}),mining.mapping.geo.geoEntity=d,d},getGeoEventEntity:function(){if(mining.mapping.geo&&mining.mapping.geo.geoEventEntity)return mining.mapping.geo.geoEventEntity;mining.mapping.geo&&mining.mapping.geo.geoEntity||mining.mappingutils.getGeoEntity();var a=mining.mappingutils.getTypeList("event"),b=mining.mapping.geo.geoEntity,c={};return $.each(a,function(a){var d=mining.mapping.objList[a];d.entity_label&&b[d.entity_label]&&(c[d.subject_label]||(c[d.subject_label]={}),c[d.subject_label][d.label]={name:d.label_name,entity_label:d.entity_label,entity_properties:d.entity_properties})}),mining.mapping.geo||(mining.mapping.geo={}),mining.mapping.geo.geoEventEntity=c,c},getEventSubjectKey:function(a){var b=mining.mapping.objList[mining.mappingutils.getName(a)],c=a.key;return b.subject_property&&a[b.subject_property]?c=a[b.subject_property]:-1!=c.indexOf("_")&&(c=c.split("_")[0]),c}}});
