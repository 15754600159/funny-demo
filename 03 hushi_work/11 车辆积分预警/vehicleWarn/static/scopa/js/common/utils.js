define("scopa/common/utils",["common/user","./serverlog","base64","core/common/showelement","core/common/snapshot"],function(a){$.extend(mining.utils,{initModule:function(b){if(!b)return $dialog.alert("请检查页面配置信息","error"),void 0;var c=[],d=[];return $.each(b,function(a,b){var c={},e=$('<div class="subpage page-'+a+'" template="'+b.template+'" style="height: 100%!important;"></div>');if(b.pageattr&&$.each(b.pageattr,function(a,b){"class"==a?e.addClass(b):e.attr(a,b)}),$.extend(c,{index:d.length+999,module:b.module,pagedom:e,async:b.async}),b.navattr&&"undefined"!=typeof b.navattr.index){var f=$('<li class="nav-'+a+'" ><a href="#!scopa/'+a+'" ><span class="text">'+b.name+"</span></a></li>");$.each(b.navattr,function(a,b){f.attr(a,b),"role"==a&&f.addClass("hide")}),$.extend(c,{key:a,navdom:f,index:b.navattr.index})}d.push(c)}),d.sort(function(a,b){return a.index>b.index?1:-1}),$.each(d,function(b,d){$(".main[role=main]").append(d.pagedom),d.navdom&&($("nav ul.navbar-nav").append(d.navdom),c.push(d.key)),"undefined"==typeof d.async||d.async||a.async(d.module)}),c},hasRoleForAction:function(a){var b=mining.userinfo.authority;if(b){mining.roleRelation||$ajax.ajax({url:mining.baseurl.console+"/application/listApplications",async:!1,success:function(a){mining.roleRelation=a.listObj},error:function(){}});for(var c=0;c<mining.roleRelation.length;c++)if(mining.roleRelation[c].key==a&&b.indexOf(mining.roleRelation[c].id)>-1)return!0}return!1},getUserInfo:function(b){var c=a("common/user"),d=function(a){try{$(".navbar .userinfo").html(a.name).attr("title",a.name),mining.userinfo=a,b&&b.call()}catch(c){}};c.get({success:d,error:function(){mining.utils.loadLogin({message:"获取用户信息失败，请重新登陆",success:d})}})},loadPage:function(a,b){if(a.hasClass("pageloaded")&&b)return b.call(),void 0;var c=a.attr("template");if(mining.utils.isEmpty(a)&&(c="/core/home"),!mining.utils.isEmpty(c)){var d=c.replaceAll("/","_"),e=staticUrl+(-1==c.indexOf("app/")?"/scopa/template/":"/")+c+".html",f=mining.utils.localStorage(mining.localname.template)||{},g=f[d];$ajax.ajax({url:e,async:!1,success:function(a){g=a,mining.utils.localStorage(mining.localname.template,$.extend(f,mining.utils.newObj(d,g)))}}),a.html(g),a.addClass("pageloaded"),b&&b.call()}},alertMsg:function(a,b,c){var d=_type="";"string"==typeof a&&"undefined"==typeof c?(d=a,_type=b):(d=mining.utils.isEmpty(b)?"":b,_type=c,mining.utils.isEmpty(a)||mining.utils.isEmpty(a.message)||(d+="：<b>"+a.message+"</b>")),$dialog.alert(d,c)},hashChange:function(a,b){var c=a||"home",d=b||"scopa",e="#!"+d+"/"+c;mining.utils.gotoUrl(location.hash?location.href.replace(location.hash,e):location.href+e)},getGraphSnapshot:function(a,b){b=b||{maxWidth:240,maxHeight:160,full:!0};var c=a.json(),d={elements:c.elements,zoom:c.zoom,pan:c.pan};try{var e=a.png(b)}catch(f){var e=""}return{graph:d,thumbnail:e}},formatSnapshotData:function(a){if(mining.utils.isEmpty(a))return null;try{a="string"==typeof a?JSON.parse(a):a}catch(b){return}if(("undefined"==typeof a.elements||mining.utils.isEmpty(a.elements))&&("undefined"==typeof a.data||mining.utils.isEmpty(a.data)))return null;var c=a;return c.data&&(c={elements:{nodes:[],edges:[]},zoom:a.params.zoom,pan:a.params.pan},a.data.v&&$.each(a.data.v,function(b,d){c.elements.nodes.push(graphModule.getnodedata(d,a.params.position[d.gid],!0))}),a.data.e&&$.each(a.data.e,function(a,b){c.elements.edges.push(graphModule.getedgedata(b,!0))})),c},openGraphSnapshot:function(a,b,c){if(b=mining.utils.formatSnapshotData(b),!mining.utils.isEmpty(b)){console.time("openGraphSnapshot"),c=c||"open",a.$(":selected").unselect(),"open"==c&&(a.elements().remove(),a.animate({zoom:b.zoom,pan:b.pan},{duration:300}));try{if(window.graphNotesMoudle){var d=[];$.each(b.elements.nodes,function(a,b){d.push(b.data.data.gid)}),window.graphNotesMoudle.isNoted({dataIds:d,async:!1,callback:function(a){notedArr=a.listObj}}),$.each(b.elements.nodes,function(a,b){var c=b.data;-1!=notedArr.indexOf(c.data.gid.toString())?(c.noted=!0,b.classes+=" noted"):(c.noted=!1,b.classes=b.classes.replace("noted",""))})}}catch(e){}a.add(mining.utils.openEventChart(b.elements));try{graphModule.adjustzoom()}catch(e){}if(!b.data)try{a.$(":selected").unselect(),window.scopa_infosideaction=!0;var f=[];b.elements.nodes&&$.each(b.elements.nodes,function(a,b){f.push("#"+b.data.id)}),a.edges(":selected").unselect(),b.elements.edges&&$.each(b.elements.edges,function(a,b){f.push("#"+b.data.id)}),a.$(f.join(",")).select(),setTimeout(function(){window.scopa_infosideaction=!1},300),console.timeEnd("openGraphSnapshot")}catch(e){}}},saveGraphHistory:function(a,b){if(window.SCOPA_openGraphFromHistory||-1==$.hash().indexOf("graph"))return window.SCOPA_openGraphFromHistory=!1,void 0;try{clearTimeout(SCOPATIMER_saveGraphHistory)}catch(c){}SCOPATIMER_saveGraphHistory=setTimeout(function(){if(!(a.elements().length>mining.graphMaxMnu)){for(var c=mining.history,d=mining.utils.localStorage(mining.localname.graphHistory)||{current:0,list:[]};d.list.length>c-1;)d.list.shift();d.list.push(mining.utils.getGraphSnapshot(a).graph),d.current=d.list.length-1,mining.utils.localStorage(mining.localname.graphHistory,d),b&&b.call(),seajs.log("保存图析历史记录成功！")}},1e3)},openGraphHistory:function(a,b,c){var d=mining.utils.localStorage(mining.localname.graphHistory)||{},e=null;if(!mining.utils.isEmpty(d)){if("forward"==b&&d.current<d.list.length-1?e=d.list[++d.current]:"backward"==b&&d.current>0?e=d.list[--d.current]:"final"==b&&(e=d.list[d.current]),null==e)return;window.SCOPA_openGraphFromHistory=!0,mining.utils.openGraphSnapshot(a,e),mining.utils.localStorage(mining.localname.graphHistory,d)}c&&c.call()},getMapSnapshot:function(a){var b=[];return $.each(a.elements(),function(a,c){$.each(c.data().data,function(a,c){b.push(c)})}),b},openMapSnapshot:function(a,b,c){try{a.clear("all")}catch(d){}if(!mining.utils.isEmpty(b))if(b[0]instanceof Array){var e=[];$.each(b,function(a,b){$.each(b,function(a,b){e.push(b)})}),b[0][0].color?a.appenddata(e,!0,c,[]):a.appenddata(e,!0,c)}else a.appenddata(b,!0,c)},saveMapHistory:function(a){if(window.SCOPA_openMapFromHistory)return window.SCOPA_openMapFromHistory=!1,void 0;if(!mining.utils.localStorage(mining.localname.mapHistory)||mining.utils.getMapSnapshot(a).length!=mining.utils.localStorage(mining.localname.mapHistory).list[mining.utils.localStorage(mining.localname.mapHistory).list.length-1].length){for(var b=mining.history,c=mining.utils.localStorage(mining.localname.mapHistory)||{current:0,list:[]};c.list.length>b-1;)c.list.shift();c.list.push(mining.utils.getMapSnapshot(a)),c.current=c.list.length-1,mining.utils.localStorage(mining.localname.mapHistory,c),seajs.log("保存地图历史记录成功！")}},openMapHistory:function(a,b,c){var d=mining.utils.localStorage(mining.localname.mapHistory)||{},e=null;if(!mining.utils.isEmpty(d)){if("forward"==b&&d.current<d.list.length-1?e=d.list[++d.current]:"backward"==b&&d.current>0?e=d.list[--d.current]:"final"==b&&(e=d.list[d.current]),null==e)return;window.SCOPA_openMapFromHistory=!0,mining.utils.openMapSnapshot(a,e,!0),mining.utils.localStorage(mining.localname.mapHistory,d)}c&&c.call()},saveFileHistory:function(){try{clearTimeout(SCOPATIMER_saveFileHistory)}catch(a){}SCOPATIMER_saveFileHistory=setTimeout(function(){for(var a=mining.history,b=mining.utils.localStorage(mining.localname.fileHistory)||{current:0,list:[]},c=mining.utils.localStorage(mining.localname.fileSnapshot)||{};b.list.length>a-1;)b.list.shift();if(b.current+1<b.list.length){var d=parseInt(b.current+1),e=parseInt(b.list.length-d);b.list.splice(d,e)}b.list.push(c),b.current=b.list.length-1,mining.utils.localStorage(mining.localname.fileHistory,b),seajs.log("保存档案历史记录成功！")},1e3)},frmatEventData:function(a,b){var c={v:mining.utils.clone(b),e:[]};return $.each(c.v,function(b,d){d.gid=d.id.replaceAll("	",""),d.etype="event",c.e.push({gid:(a.gid+d.gid).replaceAll("	",""),from:a.gid,to:d.gid,label:d.label,etype:"event",type:d.type})}),c},frmatMergeData:function(a){return $.each(a.e,function(a,b){b.class="link",b.type="other",b.etype="event"}),{v:a.v,e:a.e}},formatHartsMerge:function(a){var b=[],c={},d={},e=function(a){return a.replace("eHOTEL","ePASSPORTHOTEL").replace("eTRAIN","ePASSPORTTRAIN").replace("eFLIGHTlg","ePASSPORTFLIGHTlg")},f=function(a){return a.replace("ePASSPORTHOTEL","eHOTEL").replace("ePASSPORTTRAIN","eTRAIN").replace("ePASSPORTFLIGHTlg","eFLIGHTlg")};try{return $.each(a.hits.pairs,function(g,h){var i={},j={},k={},l={},m="";if($.each(a.hits.events,function(a,b){return b.gid==h.from?i=b:b.gid==h.to&&(j=b),mining.utils.isEmpty(i)||mining.utils.isEmpty(j)?void 0:!1}),m=i.label.toLowerCase(),"passporthotel_event"==m?m="hotel_event":"passporttrain_event"==m?m="train_event":"passportflightlg_event"==m&&(m="flightlg_event"),i=mining.mappingutils.getProperties(i,"fields"),j=mining.mappingutils.getProperties(j,"fields"),$.inArray(m,b)<0){b.push(m);var n=mining.mapping.hartsEventMapping[m]||"";c[m]=n.split(",")||[],d[m]={head:[],body:[]},$.each(c[m],function(a,b){mining.utils.isEmpty(i[b])&&mining.utils.isEmpty(j[b])||d[m].head.push({label:b,name:mining.mappingutils.getPropLabel(b)})})}$.each(c[m],function(a,b){var c=b,d=i[b]?i[b].value:"",g=j[b]?j[b].value:"";if(mining.utils.isEmpty(d)){var c=e(b);d=i[c]?i[c].value:""}if(mining.utils.isEmpty(g)){var c=e(b);g=j[c]?j[c].value:""}k[f(b)]=d,l[f(b)]=g}),d[m].body.push([k,l])}),d}catch(g){}},setTransform:function(a,b,c){return c=c||"Transform",["Moz","O","Ms","Webkit",""].forEach(function(d){$.each(a,function(){var a=$(this)[0].style[d+c];if("transform"!=c.toLowerCase()||mining.utils.isEmpty(a))$(this)[0].style[d+c]=b;else{var e=a.split(" "),f=b.split(" "),g=[];$.each(f,function(a,b){g.push(b.substring(0,b.indexOf("(")))}),$.each(e,function(a,b){var c=g.indexOf(b.substring(0,b.indexOf("(")));-1==c&&f.push(b)}),$(this)[0].style[d+c]=f.join(" ")}})}),a},checkImg:function(a,b){mining.utils.isEmpty(a)||a.size()<1||a.each(function(){mining.utils.imgloaderror(this,function(){var a=$(this).attr("_src");mining.utils.isEmpty(b)&&mining.utils.isEmpty(a)||(mining.utils.isEmpty(a)||(b=a),this.src=b)})})},dateFormat:function(a,b){var c={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds(),"q+":Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};/(y+)/.test(b)&&(b=b.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));for(var d in c)new RegExp("("+d+")").test(b)&&(b=b.replace(RegExp.$1,1==RegExp.$1.length?c[d]:("00"+c[d]).substr((""+c[d]).length)));return b},loadLogin:function(a){var b=$.extend({container:"",message:"",success:null,error:null},a),c=!1,d="string"==typeof b.container?$(b.container):b.container,e=['<div class="login_body">','<div class="center_continer">','<div class="login_content">','<div class="downloadtip">当前浏览器版本过低，请点击<a title="下载Chrome46" href="'+mining.chromePath+'">“下载”</a>安装较新的浏览器版本</div>','<form method="post" class="loginform" onsubmit="return false;">','<div class="logo login_row"></div>','<div class="login_row"><input type="text" name="username" class="input_info input_user"/></div>','<div class="login_row"><input type="password" name="password" class="input_info input_pwd"/></div>','<div class="login_row" style="height:1px;margin:0 108px;">',"</div>",'<div class="login_row row_btn">','<button class="login_btn font14 pull-right">登录</button>','<button href="javascript:;" class="login_pki_btn font14 pull-left">PKI登录</button>','<span class="errortip"></span>',"</div>",'<div class="login_row pki_btn">','<span class="nomargin pull-left"><a href="javascript://" class="a_check checked" value="0">用户</a>	<a href="javascript://" class="a_check uncheck" value="1">管理员</a></span>','<span class="nomargin pull-right"><a href="/qbbigdata.cer" target="_blank">下载证书</a></span>',"</div>",'<span class="mask_uname"></span><span class="mask_pwd"></span>',"</form>","</div>","</div>","</div>"].join(""),f=function(){$("#impot-file-state").remove(),mining.browser&&"chrome"==mining.browser.ua&&mining.browser.v<46&&$(".downloadtip",d).show(),$(".errortip",d).html(b.message),$(".a_check",d).on("click",function(){$(this).siblings().removeClass("checked").addClass("uncheck").removeAttr("checked"),$(this).addClass("checked").attr("checked","checked")}),$("select",d).select2({dropdownCssClass:"select2-login"}),mining.utils.fixAutoFill();var a,e=$(".loginform",d),f=function(){$(".errortip",e).hide().empty();var f={username:$("[name=username]",e).val(),password:$("[name=password]",e).val(),type:$(".a_check.checked",d).attr("value")};return mining.utils.isEmpty(f.username)?($(".errortip",e).show().html("请输入用户名"),!1):mining.utils.isEmpty(f.password)?($(".errortip",e).show().html("请输入密码"),!1):(clearTimeout(a),a=setTimeout(function(){$(".login_btn",e).html("登录中...")},1e3),c||mining.utils.closeDlg(),$ajax.ajax({url:mining.baseurl.pass+"/login",data:f,type:"post",success:function(a){mining.utils.closeDlg(),c&&mining.utils.isEmpty(b.success)&&(mining.utils.clearLocalData(),mining.utils.getUserInfo(function(){mining.utils.closeDlg(),mining.utils.gotoUrl((-1!=window.location.href.indexOf("core.html")?"core":"console")+".html")})),!mining.utils.isEmpty(b.success)&&$.isFunction(b.success)&&b.success.call(this,a,f)},error:function(a){a&&a.message?a.message.length&&a.message.length>30?($(".errortip",e).show().html("登录失败，请稍后重试"),$dialog.alert(a.message,"error",3e4)):$(".errortip",e).show().html(a.message):$(".errortip",e).show().html("登录失败，请稍后重试"),!mining.utils.isEmpty(b.error)&&$.isFunction(b.error)&&b.error.call(this,a)},complete:function(){clearTimeout(a),$(".login_btn",e).html("登录")}}),mining.utils.serverLog(1,"0"==f.type?"core":"console"),void 0)};$("[name=username],[name=password]",e).on("focus",function(){$(".errortip",e).empty()}),$("[name=password]",e).off("keydown").on("keydown",function(a){a.keyCode==mining.keyCode.ENTER&&f(),mining.utils.stopBubble(a)}),$(".login_btn",e).on("click",f),$(".login_pki_btn",e).off("click").on("click",function(){var a={type:$(".a_check.checked",d).attr("value")};return $.ajax({url:"https://qbbigdata.sjzs.eb:8443/console/services/plugin/gongan/auth/pkiLogin",success:function(c){if(c&&"200"==c.statusCode){var d=new Date;d.setTime(d.getTime()+2592e6),document.cookie="TUNING_SESSION_ID="+c.map.TUNING_SESSION_ID+";expires="+d.toGMTString(),!mining.utils.isEmpty(b.success)&&$.isFunction(b.success)&&b.success.call(this,c,a)}},error:function(){}}),mining.utils.serverLog(2,"0"==a.type?"core":"console"),c?!1:void 0})};d.size()>0?(c=!1,d.html(e),f()):(c=!0,mining.utils.closeDlg(),setTimeout(function(){$dialog({id:"loginDialog",title:!1,content:e,padding:0,onshow:function(){mining.utils.modalLoading("close");var a=$(this.node);$(".artui-dialog,.artui-dialog-body,.login_body",a).css({background:"none","box-shadow":"none"}),$(".artui-dialog-grid",a).attr("style","border:0!important"),$(".artui-dialog",a).css("border","none"),$(".main").addClass("blur"),d=$(this.node),this.width($(".loginform",d).width()),this.height($(".loginform",d).height()),f()},onclose:function(){$(".main").removeClass("blur"),-1!=$(".userinfo").text().indexOf("...")&&mining.utils.gotoUrl("./index.html")}}).showModal()},100))},loading:function(a){$(a).html('<tr><td colspan="12" style="height:70px" class="loading">&nbsp;</td></tr>')},removeloading:function(a){$(a).html("")},clearLocalData:function(){$.each(mining.localname,function(a,b){mining.utils.removeStorage(b)})},getPos:function(){var a=[],b=dragon.pan();return $.each(dragon.$("edge.relation"),function(c,d){var e=d.data(),f=dragon.$("#"+e.source).position(),g=dragon.$("#"+e.target).position();a.push({x1:f.x+b.x,y1:f.y+b.y,x2:g.x+b.x,y2:g.y+b.y})}),a},modalLoading:function(a){if("close"==a||$dialog.get("loginDialog"))try{$dialog.get("modalLoading").close().remove()}catch(b){}else $dialog({id:"modalLoading",title:!1,width:300,height:350,content:'<div id="modalLoading"><span class="loadingmsg">加载数据中，请您稍等......</span></div>',onshow:function(){var a=$(this.node),b=60;a.addClass("modalLoading"),a.parents(".sbody").size()<1&&(b=0),$(".artui-mask").css({background:"rgba(255,255,255,1)",opacity:"0.7",top:b+"px",overflow:"visible"}).append('<div style="width:100%;height:60px;position:relative;top:-60px;background:rgba(255,255,255,0);"></div>'),$(".artui-dialog",a).attr("style","border:none!important");try{$dialog.get("Alert").close().remove()}catch(c){}}}).showModal()},loadingMsg:function(a){if(!mining.utils.isEmpty(a))try{$($dialog.get("modalLoading").node).find(".loadingmsg").html(a)}catch(b){}},closeDlg:function(a){try{mining.utils.isEmpty(a)?$.each($dialog.list,function(a,b){b&&b.id&&b.id.indexOf&&-1!=b.id.indexOf("entityEventListDlg")?b.close():b.close().remove()}):$dialog.get(a).close().remove()}catch(b){}},isDaylightTime:function(a){try{var b="string"==typeof a?-1==a.indexOf("-")?moment(parseInt(a)):moment(a):"number"==typeof a?moment(a):a;return b.isBetween("1986-05-04 02:00:00","1986-09-14 02:00:00")||b.isBetween("1987-04-12 02:00:00","1987-09-13 02:00:00")||b.isBetween("1988-04-10 02:00:00","1988-09-11 02:00:00")||b.isBetween("1989-04-16 02:00:00","1989-09-17 02:00:00")||b.isBetween("1990-04-15 02:00:00","1990-09-16 02:00:00")||b.isBetween("1991-04-14 02:00:00","1991-09-15 02:00:00")}catch(c){return!1}},getUTCTime:function(a,b){try{var c="string"==typeof a?-1==a.indexOf("-")||0==a.indexOf("-")?moment(parseInt(a)):moment(a):"number"==typeof a?moment(a):a;return mining.utils.isDaylightTime(a)&&c.add("hour",1),b?c.format(b):c}catch(d){return a}},chartResize:function(a){try{if(window.SCOPA_ChartResize_timer&&clearInterval(window.SCOPA_ChartResize_timer),a&&"close"==a)return;window.SCOPA_ChartResize_timer=setInterval(function(){var a,b;window.SCOPA_ChartResize_timer_run=!0,window.dragon&&(a=$("#graphChart"),b=a.height(),a.height(b+10),dragon.resize(),a.height(a.parents(".graph:first").height()),dragon.resize()),(window.filegraph1||window.filegraph2)&&(a=$(".page-file .infolist.relatedchart:visible:first"),b=a.height(),a.height(b+10),window.filegraph1&&filegraph1.resize(),window.filegraph2&&filegraph2.resize(),a.height(a.parent().height()),window.filegraph1&&filegraph1.resize(),window.filegraph2&&filegraph2.resize()),window.SCOPA_ChartResize_timer_run=!1,seajs.log("*** chartResize ***")},1e4)}catch(b){}},random:function(a,b){return Math.random()*(b-a+1)+a},updateFileData:function(a,b,c){var d=mining.utils.localStorage(mining.localname.fileSnapshot)||{},e={};switch(d.current||(d.current=""),d.navtabs||(d.navtabs={}),d.filedata||(d.filedata={}),d.filecount||(d.filecount={}),a){case"del":d=mining.utils.delFileDataAction(d,b);break;case"changeTab":d=mining.utils.changeTabFileDataAction(d,b);break;case"changeItem":d=mining.utils.changeItemFileDataAction(d,b);break;case"addItem":d=mining.utils.addFileDataAction(d,b,function(a){e=a});break;case"changeKey":d=mining.utils.changeKeyAction(d,b);break;default:d=mining.utils.addTabDataAction(d,b,function(a){e=a})}mining.utils.localStorage(mining.localname.fileSnapshot,d),("del"==a||"addItem"==a&&e.length>0||"add"==a)&&mining.utils.saveFileHistory(),c&&c(e)},addTabDataAction:function(a,b,c){if(0!==b.dataArr.length){var d=b.dataArr,e=d[0],f=parseInt(1e3*Math.random()).toString(),g={tabid:"tab"+e.gid+f,tabtitle:"&nbsp;",tabtype:b.tabType||"1",filelist:[],grouplist:[],current:e.gid};return"1"==b.tabType?mining.mappingutils.getTitle(e)&&""!=mining.mappingutils.getTitle(e)&&(g.tabtitle=mining.mappingutils.getTitle(e)):"2"==b.tabType?(g.tabid="tab"+e.label.id+f,g.current=e.label.id,g.tabtitle=e.label.name):g.tabtitle=e.filename,$.each(d,function(c,d){var e=d.gid;"1"==b.tabType?g.filelist.pushOnly(e):"2"==b.tabType&&(e=d.label.id,g.grouplist.pushOnly(e)),a.filecount.hasOwnProperty(e)||(a.filecount[e]=0),a.filecount[e]++,a.filedata.hasOwnProperty(e)||(a.filedata[e]=d)}),c&&c(g),a.navtabs[g.tabid]=g,a=mining.utils.changeTabFileDataAction(a,{tabId:g.tabid})}},addFileDataAction:function(a,b,c){var d=b.dataArr,e=b.tabId,f=(b.tabType,a.navtabs[e]),g=[];return $.each(d,function(b,c){f.filelist.pushOnly(c.gid);var d=c.gid;a.filecount.hasOwnProperty(d)||(a.filecount[d]=0),a.filecount[d]++,a.filedata.hasOwnProperty(d)||(a.filedata[d]=c,g.push(c))}),c&&c(g),a.navtabs[e]=f,a=mining.utils.changeItemFileDataAction(a,{tabId:e,itemId:d[0].gid})},delFileDataAction:function(a,b){var c=b.dataIdArr,d=b.tabId,e=a.navtabs[d],f=!1,g=!1,h=!1;if(3==e.tabtype&&(h=!0,a.filecount[d]--,delete a.filedata[d]),$.each(c,function(b,c){var f=c;f==e.current&&(g=!0),a.navtabs[d].filelist.remove(f),a.navtabs[d].grouplist.remove(f),a.filecount.hasOwnProperty(f)&&(a.filecount[f]--,0==a.filecount[f]&&(delete a.filecount[f],delete a.filedata[f]))}),h||0==a.navtabs[d].filelist.length&&0==a.navtabs[d].grouplist.length){delete a.navtabs[d],f=!0;var i="";a.current==d&&($.each(a.navtabs,function(a){i=a}),a=mining.utils.changeTabFileDataAction(a,{tabId:i}))}return g&&!f&&(a=mining.utils.changeItemFileDataAction(a,{tabId:d,itemId:a.navtabs[d].grouplist[0]||a.navtabs[d].filelist[0]})),a},changeTabFileDataAction:function(a,b){return a.current=b.tabId,a},changeItemFileDataAction:function(a,b){return a.navtabs[b.tabId].current=b.itemId,a},changeKeyAction:function(a,b){var c=b.keyId,d=b.newKeyId,e=b.docId,f=b.newDocId,g=a.navtabs[c],h=a.filedata[e],i=a.filecount[e];return g.tabid=d,g.current=f,delete a.navtabs[c],a.navtabs[d]=g,h.gid=f,delete a.filedata[e],a.filedata[f]=h,delete a.filecount[e],a.filecount[f]=i,a.current=d,a},serverLog:function(a,b){return},toAppHome:function(){window.toAppHome=window.top.toAppHome=!0;var a=$.hash();return mining.utils.isEmpty(a)&&window.top?(window.top.mining.utils.hashChange("app"),void 0):(mining.utils.hashChange("app"),void 0)},getHartsData:function(a){var b=$.extend({data:null,success:null,error:null},a);mining.utils.isEmpty(b.data)||mining.utils.isEmpty(b.success)||$ajax.ajax({url:mining.baseurl.harts+"/event",data:{eid0:b.data.from_key,eid1:b.data.to_key,eventLabel:mining.mappingutils.getHartEvents(b.data).join(","),ruleId:mining.mappingutils.getRuleIds(b.data).join(",")},success:function(a){b.success&&b.success(a)},error:function(a){b.error&&b.error(a)}})},judgedDataByPhones:function(a){if(mining.utils.isEmpty(a))return $dialog.alert("未获取到任何话单数据","warning"),void 0;var b=$dialog.topIndex();$dialog({id:"dataByPhones",title:"研判-话单分析",zIndex:++b,content:'<span class="artui-dialog-confirm"></span><span>是否清空话单已有分析结果？</span>',button:[{value:"是",callback:function(){try{scopaConfig.pages.judged.getJudgedDataByPhones(a,!0)}catch(b){}mining.utils.hashChange("ticket"),mining.utils.closeDlg()},autofocus:!0},{value:"否",callback:function(){try{scopaConfig.pages.judged.getJudgedDataByPhones(a,!1)}catch(b){}mining.utils.hashChange("ticket"),mining.utils.closeDlg()}},{value:"取消"}]}).showModal()},fileDownload:function(a,b,c){var d=document.createElement("iframe");d.style="visibility: collapse;",document.body.appendChild(d);var e=d.contentDocument,f=document.createElement("form");f.style.display="none",f.action=a,f.method=c||"post",e.body.appendChild(f);for(var g in b){var h=document.createElement("input");h.type="hidden",h.name=g,h.value=b[g],f.appendChild(h)}$("form",e).submit(),setTimeout(function(a){return function(){a.remove()}}(d),2e3)},imgDownload:function(a,b){var c=document.createElement("a"),d=a.lastIndexOf("/"),e=a.lastIndexOf("."),f="download",g=".jpg";-1!=e?g=a.substr(a.lastIndexOf("."),a.length-1):-1!=a.indexOf("data:image/png;base64")&&(g=".png"),-1!=d&&(f=a.substr(a.lastIndexOf("/")+1,a.length-1)),c.href=a,c.download=(b||f)+g,c.click()},txtDownload:function(b,c){try{b="string"==typeof b?b:JSON.stringify(b)}catch(d){return}a("base64");var e="data:text/html;charset=utf-8;base64,"+doBase64.encode(b),f=document.createElement("a");f.href=e,f.style="visibility:hidden",f.download=c+".txt",document.body.appendChild(f),f.click(),document.body.removeChild(f)},getVertex:function(a,b){return a=a||"",$.isArray(a)&&(a=a.join(",")),mining.utils.isEmpty(a)?(b&&b({v:[],e:[]}),void 0):($ajax.ajax({url:mining.baseurl.core+"/query/getVertexByIndex",data:{value:a,index:"key"},success:function(a){b(a)},error:function(a){mining.utils.alertMsg(a,"获取信息失败，请稍后重试！","error")}}),void 0)},showPhoneGraph:function(b,c){c=c||"graph","graph"==c?mining.utils.getVertex(b,function(b){if(a("core/common/showelement").show(b,c),"graph"==c&&b&&b.v.length>0){var d,e=0;d=setInterval(function(){if((dragon.$("#"+b.v[0].gid)||e>1e5)&&(clearInterval(d),window.graphmenuModule)){var a=[];$.each(b.v,function(b,c){a.push(c.gid)}),a.length>1&&window.graphmenuModule.expandRelation(a,[],1,"",!0)}e+=100},100)}}):a("core/common/showelement").show({v:[b]},c)},openEventChart:function(a,b){if(!a.nodes)return a;var c={nodes:[],edges:[]},d=[],e=[];if($.each(a.nodes,function(c,f){var g=f.data.data;if("event"==g.etype){if(d.push(g),mining.utils.isEmpty(a.nodes))return;$.each(a.edges,function(c,d){var f=d.data.data,h="";f.from==g.gid?h=f.to:f.to==g.gid&&(h=f.from),""!=h&&(e.push(f.gid),mining.utils.isEmpty(b)&&$.each(a.nodes,function(a,c){return c.data.data.gid==h?(b=c.data.data,!1):void 0}))})}}),d.length>0){$.each(a.nodes,function(a,b){"event"!=b.data.data.etype&&c.nodes.push(b)}),a.edges&&$.each(a.edges,function(a,b){-1==e.indexOf(b.data.data.gid)&&c.edges.psuh(b)});var f,g=0;f=setInterval(function(){(window.graphEventModule||g>1e5)&&(clearInterval(f),window.graphEventModule&&window.graphEventModule.appenddata(b,d)),g+=100},100)}else c=a;return c},openSnapshot:function(b){a("core/common/snapshot").open(b)},formatHeatData:function(a){var b=[],c=[],d={min:10,max:100};if(!a.data)return a;$.each(a.data,function(a,c){b.push(c.count)});var e=b.min(),f=b.max(),g=(d.max-d.min)/(f-e);return $.each(a.data,function(a,b){b.count=(b.count-e)*g+d.min,c.push(b.count)}),a.max=d.max,a},json2xls:function(a){var b={data:{thead:[],tbody:[]},filename:"下载",ignoreColumn:[],consoleLog:"false"},a=$.extend(b,a),c="<table>";$.each(a.data.thead,function(a,d){c+="<tr>",$.each(d,function(a,d){-1==b.ignoreColumn.indexOf(a)&&(c+="<td>"+d+"</td>")}),c+="</tr>"});var d=1;$.each(a.data.tbody,function(a,e){c+="<tr>";var f=0;$.each(e,function(a,d){-1==b.ignoreColumn.indexOf(a)&&(c+="<td>"+d+"</td>"),f++}),d++,c+="</tr>"}),c+="</table>","true"==b.consoleLog&&console.log(c);var e="<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:"+b.type+"' xmlns='http://www.w3.org/TR/REC-html40'>";e+="<head>",e+="<!--[if gte mso 9]>",e+="<xml>",e+="<x:ExcelWorkbook>",e+="<x:ExcelWorksheets>",e+="<x:ExcelWorksheet>",e+="<x:Name>",e+="{worksheet}",e+="</x:Name>",e+="<x:WorksheetOptions>",e+="<x:DisplayGridlines/>",e+="</x:WorksheetOptions>",e+="</x:ExcelWorksheet>",e+="</x:ExcelWorksheets>",e+="</x:ExcelWorkbook>",e+="</xml>",e+="<![endif]-->",e+="</head>",e+="<body>",e+=c,e+="</body>",e+="</html>";var f="data:application/vnd.ms-excel;charset=utf-8,"+encodeURIComponent(e),g=document.createElement("a");g.href=f,g.style="visibility:hidden",g.download=b.filename+".xls",document.body.appendChild(g),g.click(),document.body.removeChild(g)},openSubGraph:function(a){if(!(mining.utils.isEmpty(a)||a.elements().length<1)){var b="";$dialog({title:"研判-图析",content:'<span class="artui-dialog-confirm"></span><span>是否清空图析已有分析结果？</span>',button:[{value:"是",callback:function(){b="open"},autofocus:!0},{value:"否",callback:function(){b="import"}},{value:"取消"}],onclose:function(){mining.utils.isEmpty(b)||(mining.utils.localStorage(mining.localname.graphSnapshot,{graph:JSON.stringify(mining.utils.getGraphSnapshot(a).graph),action:b}),mining.utils.hashChange("graph"))}}).showModal()}},getEventSubject:function(a,b){mining.utils.getVertex(mining.mappingutils.getEventSubjectKey(a),function(a){if(b)try{b(a.v[0])}catch(c){b(void 0)}})},setWaterMark:function(){$("#watermark").size()<1&&$("body").append('<canvas id="watermark" style="pointer-events:none;position:fixed;z-index:9999;display:block;top:0;"></canvas>');var a=$(document).width(),b=$(document).height();$("#watermark").attr("width",a),$("#watermark").attr("height",b);var c=document.getElementById("watermark").getContext("2d"),d=mining.userinfo.user_id,e=Math.ceil(c.measureText(d).width)+40,f=114,g=b/Math.sin(30*(2*Math.PI/360)),h=Math.sin(30*(2*Math.PI/360))*b/Math.sin(60*(2*Math.PI/360)),g=a>g?a:g,i=Math.ceil(g/f),j=Math.ceil(g/e);c.font="16px sans-serif",c.fillStyle="rgba(132,147,183,.2)",c.rotate(-30*Math.PI/180),c.translate(-h,0);for(var k=0;i>k;k++)for(var l=0;j>l;l++)c.fillText(d,e*l,f*k)}}),function(a){a.extend(a.fn,{transform:function(b,c){return this.each(function(){mining.utils.setTransform(a(this),b,c)})},table2xls:function(b){function c(a){return content_data="true"==d.htmlContent?a.html().trim():a.text().trim()}var d={filename:"下载",ignoreColumn:[],htmlContent:"false",consoleLog:"false"},b=a.extend(d,b),e=this,f="<table>";a(e).find("thead").find("tr").each(function(){f+="<tr>",a(this).filter(":visible").find("th").each(function(b){"none"!=a(this).css("display")&&-1==d.ignoreColumn.indexOf(b)&&(f+="<td>"+c(a(this))+"</td>")}),f+="</tr>"});var g=1;a(e).find("tbody").find("tr").each(function(){f+="<tr>";var b=0;a(this).filter(":visible").find("td").each(function(e){"none"!=a(this).css("display")&&-1==d.ignoreColumn.indexOf(e)&&(f+="<td>"+c(a(this))+"</td>"),b++}),g++,f+="</tr>"}),f+="</table>","true"==d.consoleLog&&console.log(f);var h="<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:"+d.type+"' xmlns='http://www.w3.org/TR/REC-html40'>";h+="<head>",h+="<!--[if gte mso 9]>",h+="<xml>",h+="<x:ExcelWorkbook>",h+="<x:ExcelWorksheets>",h+="<x:ExcelWorksheet>",h+="<x:Name>",h+="{worksheet}",h+="</x:Name>",h+="<x:WorksheetOptions>",h+="<x:DisplayGridlines/>",h+="</x:WorksheetOptions>",h+="</x:ExcelWorksheet>",h+="</x:ExcelWorksheets>",h+="</x:ExcelWorkbook>",h+="</xml>",h+="<![endif]-->",h+="</head>",h+="<body>",h+=f,h+="</body>",h+="</html>";var i="data:application/vnd.ms-excel;charset=utf-8,"+encodeURIComponent(h),j=document.createElement("a");j.href=i,j.style="visibility:hidden",j.download=d.filename+".xls",document.body.appendChild(j),j.click(),document.body.removeChild(j)}})}(jQuery)});
