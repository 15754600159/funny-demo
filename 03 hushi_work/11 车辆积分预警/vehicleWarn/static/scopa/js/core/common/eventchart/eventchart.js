define("scopa/core/common/eventchart/eventchart",[],function(a,b,c){c.exports=function(){var a={graph:null,readyCallback:null,selectCallback:null,resizeCallback:null,clickCallback:null,dblclickCallback:null,dataCallback:null},b="entityEventListDlg-",c=[],d={},e=function(b){$.extend(a,b)},f=function(a){return b+a.gid},g=function(a){return a.id.replace(b,"")},h=function(a){return $dialog.get(f(a))},i=function(){"graph"==$.hash("parse").scopa&&$.each($dialog.list,function(a,c){c.open||-1==a.indexOf(b)||(c.show(),c.offset&&$(c.node).css({left:c.offset.left,top:c.offset.top}))}),$.each(c,function(b,c){var d=$dialog.get(c);if(d){var e=g(d),f=!1;$.each(e.split("_"),function(b,c){return a.graph.$("#"+c).length>0?(f=!0,!1):void 0}),f||d.close().remove()}})},j=function(){$.each(c,function(a,b){var c=$dialog.get(b);if(c){var d=$(c.node),e=c.typeArr||[],f=[],g=[];$(".eventtype",d).removeClass("active"),$("[objname]:hidden",d).not(".nofilter").show(),$.each(e,function(a,b){var c=(mining.mappingutils.getFontName(b),mining.mappingutils.getTypeName(b)),e=$("[objname="+b+"]:visible",d).size();g.push(c+"："+e),f.push('<span class="eventtype" type="'+b+'"  title="'+c+'"><span class="font20 '+mining.mappingutils.getFontName(b)+'"></span>'+e+"</span>")}),$(".eventcountlist",d).html(f.join("&nbsp;|&nbsp;")).attr("title",g.join("；")),$("[objname=phone_event_other]:visible",d).size()<1?$(".action-ticket",d).addClass("disabled"):$(".action-ticket",d).removeClass("disabled")}})},k=function(){if(!$(this).hasClass("disabled")){var a=$(this).parents(".eventlistdlg:first"),b=$("[objname].active:visible",a),c=mining.localname.mapSnapshot,e=[];b.size()<1&&(b=$("[objname]:visible",a)),b.each(function(){var a=$(this).attr("gid"),b=d[a];b&&e.push(b)});var f=mining.utils.localStorage(c)||[];mining.utils.localStorage(c,f.concat(e)),mining.utils.hashChange("map"),mining.utils.serverLog(81)}},l=function(){if(!$(this).hasClass("disabled")){var a=$(this).parents(".eventlistdlg:first"),b=$("[objname=phone_event_other].active:visible",a),c=[];b.size()<1&&(b=$("[objname=phone_event_other]:visible",a)),b.each(function(){var a=$(this).attr("gid"),b=d[a].key;b&&c.pushOnly(b)}),mining.utils.judgedDataByPhones(c),mining.utils.serverLog(82)}},m=function(){var a=$(this).parents(".eventlistdlg:first");return $(this).toggleClass("active"),$(".eventtype.active",a).size()<1?($("[objname]",a).not(".nofilter").show(),void 0):($(".eventtype",a).each(function(){var b=$(this).attr("type"),c=$("[objname="+b+"]",a).not(".nofilter");$(this).hasClass("active")?c.show():c.hide()}),void 0)},n=function(b,e){if(b&&!($.isArray(b)&&b.length<1)&&($.isArray(b)||b.gid)){var g={gid:"",title:"",position:{x:100,y:100}};if($.isArray(b)){var i=[];$.each(b,function(a,b){i.push(b.gid)}),g.gid=i.join("_")}else g.gid=b.gid;var j=f(g),n=h(g);if(e.length>500&&(mining.utils.modalLoading(),mining.utils.loadingMsg("生成事件数据列表，请您稍等......")),mining.utils.isEmpty(n)){var p="",q=[],r=58;if($.isArray(b))$.each(b,function(a,b){q.push(mining.mappingutils.getTitle(b))}),g.title=q.join(" - "),g.position=a.graph.$("#"+b[0].gid).position(),p="事件对比：",r=82;else{var s=mining.mappingutils.getShowlabel(b,"big");$.each(s,function(a,b){q.push(b.value)}),g.title=q.join("-"),p="主体："}c.push(j),n=$dialog({id:j,title:p,padding:0,width:500,onshow:function(){var b=this,c=$(this.node);c.addClass("eventlistdlg"),b.content(['<div class="eventlistdlg">','<table class="grid newtable"><thead><tr><th class="txtc" style="width:66px">类型</th><th style="width:160px">更新时间</th><th>事件描述</th></tr></thead></table>','<div class="eventlist">','<table class="grid newtable"><tbody></tbody></table>',"</div>",'<div class="eventcountlist"></div>',"</div>"].join("")),$(".artui-dialog-title",c).append('<span class="elabel ellipsis" title="'+g.title+'" style="left:'+r+'px">'+g.title+"</span>"),$(".artui-dialog-header",c).append('<a class="actionbtn action-map" title="到地图" href="javascript:;"><span class="font20 graphicon scopaicon-daoditu"></span></a><a class="actionbtn action-ticket" title="到话单" href="javascript:;"><span class="font20 graphicon scopaicon-daohuadan20"></span></a>'),$(".eventlist",c).mCustomScrollbar({theme:"minimal"}),-1!=$.hash().indexOf("map")&&$(".action-map",c).addClass("disabled"),c.off("click",".action-map").on("click",".action-map",k),c.off("click",".action-ticket").on("click",".action-ticket",l),c.off("click",".eventlist tbody tr").on("click",".eventlist tbody tr",function(b){var d=$(this).prevAll("tr.active:first");if($(this).toggleClass("active"),b.shiftKey&&d.size()>0){for(var e=d.index()+1,f=$(this).index(),g=e;f>g;g++)$(".eventlist tbody tr:eq("+g+")",c).addClass("active");window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()}b.ctrlKey||b.shiftKey||$(this).siblings(".active").removeClass("active"),a.selectCallback&&a.selectCallback.call()}),c.off("click",".eventtype").on("click",".eventtype",m);try{var d=a.graph.pan(),f=a.graph.zoom(),h=g.position,i=h.x*f+d.x+40,j=h.y*f+d.y+90;i=i>mining.browser.w-500?mining.browser.w-500:i,i=10>i?10:i,j=j>mining.browser.h-450?mining.browser.h-450:j,j=100>j?100:j,c.css("left",i+"px"),c.css("top",j+"px")}catch(n){}o(b,e),$(".artui-dialog-footer",c).parent().remove()},onremove:function(){var b=this;$node=$(this.node),this.offset={left:parseInt($node.css("left")),top:parseInt($node.css("top"))},$(".eventlist tbody tr",$node).each(function(){delete d[$(this).attr("gid")]}),c.remove(b.id),a.dataCallback&&a.dataCallback.call()},cancel:!0}).show()}else o(n,e)}},o=function(b,c){var e=$(b.node),f=b.typeArr||[],g="";$.each(c,function(a,b){if(!($(".eventlist tr[gid="+b.id+"]",e).size()>0)){var c=mining.mappingutils.getProperties(b,"primary"),h=mining.mappingutils.getTimeProp(b),i=mining.mappingutils.getName(b),j=mining.mappingutils.getTypeName(b),k=[];mining.utils.isEmpty(c)||(f.pushOnly(i),$.each(c,function(a,b){k.push(b.value)}),g+=['<tr gid="'+b.id+'" objname="'+i+'">','<td class="txtc" style="width:66px"><span class="font20 '+mining.mappingutils.getFontName(b)+'" title="'+j+'"></span></td>','<td class="time" style="width:160px">'+h.value+"</td>","<td>"+k.join("&nbsp;&nbsp;")+"</td>","</tr>"].join(""),b.etype="event",b.gid=b.id,d[b.id]=b)}}),$(".eventlist tbody",e).append(g),b.typeArr=f,j(),p(b),a.dataCallback&&a.dataCallback.call()},p=function(a){var b=$(a.node),c=[];$(".eventlist tbody tr",b).each(function(){c.push($(this)[0].outerHTML)}),c.sort(function(a,b){return new Date($(b).find(".time").text())-new Date($(a).find(".time").text())}),$(".eventlist tbody",b).html(c.join(""))},q=function(a){$.each(a,function(a,b){try{h(b).close().remove()}catch(c){}})},r=function(a,b,c){$.each(b,function(a,b){$('.eventlistdlg .eventlist tr[objname="'+b+'"]').removeClass("nofilter")}),$.each(c,function(a,b){$('.eventlistdlg .eventlist tr[objname="'+b+'"]').addClass("nofilter")}),$(".eventlistdlg .eventlist tr:visible").each(function(){var b=$(this).find(".time").text(),c=new Date(b);a[0]<=c&&c<=a[1]?$(this).removeClass("nofilter"):$(this).addClass("nofilter")}),j()},s=function(a){$(".eventlistdlg .eventlist tr").removeClass("nofilter"),$.each(a,function(a,b){$('.eventlistdlg .eventlist tr[objname="'+b+'"]').addClass("nofilter")}),j()},t=function(){$(".eventlistdlg .eventlist tr.nofilter").removeClass("nofilter"),j()},u=function(a,b){var c=[];if(a=a||"",mining.utils.isEmpty(a))$.each(d,function(a,b){b&&c.push(b)});else if(":selected"==a)$(".eventlistdlg .eventlist tr.active").each(function(){var a=d[$(this).attr("gid")];a&&c.push(a)});else{if($(".eventlistdlg .eventlist tr[gid="+a+"]").size()>0)return d[a]||[];b&&":selected"==b?$(".eventlistdlg .eventlist tr[objname="+a+"].active").each(function(){var a=d[$(this).attr("gid")];a&&c.push(a)}):$('.eventlistdlg .eventlist tr[objname="'+a+'"]').each(function(){var a=d[$(this).attr("gid")];a&&c.push(a)})}return c},v=function(b){b=b||"all","all"==b?$.each(c,function(a,b){var c=$dialog.get(b);c&&c.close().remove()}):":selected"==b&&$(".eventlistdlg .eventlist tr.active").each(function(){$(this).attr("gid"),delete d[$(this).attr("gid")],$(this).remove()}),a.dataCallback&&a.dataCallback.call(),j()},w=function(a,b){if(!mining.utils.isEmpty(b)){var c=[];$.each(b,function(a,b){c.push($(".eventlistdlg [gid="+b+"]").addClass("active"))}),c.sort(function(a,b){return new Date($(a).find(".time").text())-new Date($(b).find(".time").text())}),$.each(c,function(a,b){b.insertBefore(b.siblings().first())})}};return{init:e,refresh:i,getdata:u,appenddata:n,closeevent:q,delelements:v,timefilter:r,labelfilter:s,closefilter:t,highlight:w}}});
