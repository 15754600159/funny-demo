define("scopa/core/common/timeline",["timeline","moment","ztree","./drawpath","../../common/cartoon"],function(a,b,c){a("timeline"),a("moment"),a("ztree");var d=a("./drawpath");c.exports=function(){var b,c,e,f,g,h,i,j={graph:null,eventModule:null,container:null,timefilter:null,legendfilter:null,scale:"full"};window.scopa_timelineaction=!1;var k=function(a){a=$.extend({},j,a),c=a.graph,e=a.eventModule,b=a.container="string"==typeof a.container?$(a.container):a.container,g=a.timefilter,h=a.legendfilter,i=a.playerData},l=function(a){k(a),mining.utils.isEmpty(c)||b.size()<1||m(a)},m=function(a){k(a),s(a),t(),$(".scalebtn,.scaleimg",b).off("click").on("click",function(){$(".scalebtn-full",b).is(":visible")?w($.extend(a,{scale:"small"})):w($.extend(a,{scale:"full"}))})},n=mining.utils.localStorage(mining.localname.localcolor)||{},o=0,p=["#17becf","#1f77b4","#98df8a","#ffbb78","#c5b0d5","#f7b6d2","#7f7f7f","#dbdb8d","#9edae5","#c49c94","#aec7e8","#e377c2","#bcbd22","#ff9896","#c7c7c7","#9467bd","#8c564b","#d62728","#ff7f0e","#2ca02c"];$.each(p,function(a,b){p[a]=mining.utils.getRGB(b,1)}),window.autoPlay=function(a,b,c,e){a?($(".play-config-box .play-duration").prop("disabled",!1),$(".play-config-box .play-btn").css("cursor","pointer")):($(".play-config-box .play-duration").prop("disabled",!0),$(".play-config-box .play-btn").removeAttr("style").removeClass("stop").addClass("play"),d.clearPath()),b&&$(".play-config-box .play-btn").removeClass("stop").addClass("play"),$(".play-config-box").off("click",".play").on("click",".play",function(){if(a){var b=1e3*parseInt($(".play-config-box select.play-duration").val());$(this).removeClass("play").addClass("stop"),q(b,c,e)}}),$(".play-config-box").off("click",".play-btn.stop").on("click",".play-btn.stop",function(){a&&$(this).removeClass("stop").addClass("play")})};var q=function(a,b,c){var e=new Date(b[0]).getTime();i(e,c,function(b,f){b=b,f=f;var g={container:"#mapGraph",pathData:b,waitPath:f,startTime:e,endTime:c,playTime:a};d.init(g),brushAutomove&&brushAutomove(a)})},r=function(a,b){if(!mining.utils.isEmpty(b)&&n&&n[b])return n[b];for(;a>p.length-1;)a-=p.length;for(0>a&&(a=0);$('.legendcolor[value="'+p[a]+'"]').size()>0&&a<p.length-1;)a++,o++;return console.log("颜色index= "+a),p[a]},s=function(d){var g={view:{nameIsHTML:!0,showIcon:!1,showTitle:!1,selectedMulti:!1},check:{enable:!0},config:d,callback:{onCheck:function(a,b,c){t();var d=[];$.each(f.getCheckedNodes(!1),function(a,b){b.label&&d.push(b.label)}),h&&h(d),-1!=$.hash().indexOf("graph")?mining.utils.serverLog(46,mining.mappingutils.getTypeName(c)):$(".page-map .breadnav-map").hasClass("active")&&mining.utils.serverLog(66,mining.mappingutils.getTypeName(c))}}},i={relation:{name:"关系类别",types:[],children:[]},event:{name:"事件类别",types:[],children:[]},entity:{name:"实体类别",types:[],children:[]}},j=[],k=[];o=0,$.each(c.$("node.entity,edge.relation,node.event"),function(a,b){b.data().data&&(b.data().data instanceof Array?$.each(b.data().data,function(a,b){j.push(b)}):j.push(b.data().data))}),j=e.getdata().concat(j),$.each(j,function(a,b){var c=b,d=c.etype,e=mining.mappingutils.getTimeList(c),f="";mining.utils.isEmpty(e)||$.each(e,function(a,b){-1==i[d].types.indexOf(b.label)&&(f=r(o,b.label),n[b.label]=f,i[d].children.push({name:'<span class="legenditem"><span class="legendtext">'+b.name+'</span><input type="text" class="legendcolor" value="'+f+'" label="'+b.label+'" style="background:'+f+'"></span>',checked:!0,label:b.label,color:f}),i[d].types.push(b.label),o++)})}),mining.utils.localStorage(mining.localname.localcolor,n),$.each(i,function(a,b){b.children.length<1||k.push({name:b.name,labe:a,open:!0,checked:!0,children:b.children})}),f=$.fn.zTree.init($(".legendtree",b),g,k),a.async("colorpicker",function(){$("input.legendcolor",b).colorPicker({appendTo:document.body,margin:{left:30,top:-160},customBG:"#222",readOnly:!0,init:function(a,b){a.style.backgroundColor=a.value,a.style.color=b.rgbaMixCustom.luminance>.22?"#222":"#ddd"},actionCallback:function(){$(".legendcolor",b).each(function(){n[$(this).attr("label")]=$(this).val()}),mining.utils.localStorage(mining.localname.localcolor,n),t()}})}),$(".legendcolor-clear",b).size()<1&&($(".legendbox",b).append('<a class="legendcolor-clear" href="javascript:;" title="清除自定义颜色"></a>'),$(".legendcolor-clear",b).off("click").on("click",function(){$("input.legendcolor",b).each(function(){}),n={},mining.utils.localStorage(mining.localname.localcolor,n),s(),t()})),$(".legendbox",b).mCustomScrollbar({scrollButtons:{enable:!0},theme:"dark-thin"})},t=function(){var a={},h=[],i=[],j=[],k=[],l=[];$.each(f.getCheckedNodes(!0),function(a,b){b.label&&j.push(b.label)}),$.each(f.getCheckedNodes(!1),function(a,b){b.label&&k.push(b.label)}),$.each(c.$("node.entity,edge.relation,node.event"),function(a,b){b.data()&&b.data().data&&(b.data().data instanceof Array?$.each(b.data().data,function(a,b){l.push(b)}):l.push(b.data().data))}),l=e.getdata().concat(l),$.each(l,function(b,c){var d=c,e=(d.etype,mining.mappingutils.getTimeList(d));$.each(e,function(b,c){-1==j.indexOf(c.label)||mining.utils.isEmpty(c.time)||(mining.utils.isEmpty(a[c.label])&&(a[c.label]=[]),a[c.label].push(d))})}),$.each(a,function(a,b){var c={name:a,data:[]};$.each(b,function(a,b){var d=mining.mappingutils.getTimeList(b);$.each(d,function(a,b){$.each(b.time,function(a,b){var d=parseInt(b),e=-1;$.each(c.data,function(a,b){return b.time==d?(e=a,!1):void 0}),-1!=e?c.data[e].count++:(c.data.push({time:d,count:1}),-1==i.lastIndexOf(d)&&i.push(d))})})}),h.push(c)});var m=mining.utils.clone(h);$.each(m,function(a,b){var c=[];$.each(i,function(a,d){var e=!1;$.each(b.data,function(a,b){return b.time==d?(e=!0,!1):void 0}),e||c.push({count:0,time:d})}),h[a].data=h[a].data.concat(c)});var n=null,o=null,p=2592e6;$.each(h,function(a,b){b.data.sort(function(a,b){return a.time>b.time?1:-1}),n=b.data[b.data.length-1].time+1*p,o=b.data[0].time-1*p,$.each(b.data,function(a,b){b.time=new Date(b.time)})});var q;do q="timeLineChart"+mining.utils.randomInt(0,100);while($("#"+q).size()>0);$(".chartbox",b).html('<div class="timeLineChart" id="'+q+'"></div>');var s=d3.chart.timeline().height(180).width($(".timeLineChart",b).width()).start(new Date(o)).end(new Date(n)).eventColor(r).eventHover(function(){}).eventZoom(function(){}).brushStart(function(){scopa_timelineaction=!0,-1!=$.hash().indexOf("graph")?mining.utils.serverLog(47):$(".page-map .breadnav-map").hasClass("active")&&mining.utils.serverLog(67)}).brushMove(function(a){g&&g(a.extent(),j,k),$(".play-config-box .play-btn").hasClass("play")||d.getPath(a.extent()[0].getTime(),a.extent()[1].getTime())}).brushEnd(function(a,b){autoPlay(!0,!1,a.extent(),b)}).brushClose(function(){autoPlay(!1),u()}),t=d3.select("#"+q).datum(h);s(t),u()},u=function(){try{c.$(".nofilter").removeClass("nofilter")}catch(a){$.each(c.$(".nofilter"),function(a,b){b.removeClass("nofilter")})}scopa_timelineaction=!1,e.closefilter()},v=!1,w=function(a){if(!v){v=!0,k(a);var d=b.siblings(".graph"),e=parseInt($(".graphnavigator",d).css("top"));"small"==a.scale&&$(".scalebox .scalebtn-small",b).is(":hidden")?(b.animate({width:80,height:102,top:-102},300).addClass("scale-small"),d.add($("#graphChart,#mapGraph",d)).animate({height:d.height()+180},300),$(".graphnavigator",d).animate({top:e+180},300),$(".scalebox",b).width(80).height(102),$(".scalebox .scalebtn-small",b).show(),$(".scalebox .scalebtn-full",b).hide(),setTimeout(function(){$(".scalebox .scaleimg",b).fadeIn(300)},200)):"full"==a.scale&&$(".scalebox .scalebtn-full",b).is(":hidden")&&(b.animate({width:"100%",height:180,top:0},300).removeClass("scale-small"),d.add($("#graphChart,#mapGraph",d)).animate({height:d.height()-180},300),$(".graphnavigator",d).animate({top:e-180},{duration:300}),$(".scalebox",b).width(22).height(22),$(".scalebox .scalebtn-full",b).show(),$(".scalebox .scaleimg,.scalebox .scalebtn-small",b).hide()),setTimeout(function(){c.resize(),v=!1},400)}};return{init:l,refresh:m,scale:w}}});
