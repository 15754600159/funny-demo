define("scopa/core/common/customelement",[],function(){var a={addentity:mining.baseurl.core+"/customelement/addEntity",addrelation:mining.baseurl.core+"/customelement/addRelation",delentity:mining.baseurl.core+"/customelement/deleteEntity",delrelation:mining.baseurl.core+"/customelement/deleteRelation",listentity:mining.baseurl.core+"/customelement/listEntitiesByUser",listrelation:mining.baseurl.core+"/customelement/listRelationsByUser	"},b={person:["PERSON_xm"],vehicle:[],custom_relation_other:["relation_name"]},c=[],d=function(a){var b=$.extend({type:"entity",fromid:"",toid:"",success:null,error:null},a);switch(b.type){case"entity":e(b);break;case"relation":f(b)}},e=function(c){var d=$.extend({success:null,error:null},c);$dialog({title:"添加实体",width:500,padding:"20px 0 0",onshow:function(){var a=this,c=$(this.node);$(".main").addClass("blur"),a.content(['<form class="form-horizontal required-validate" onsubmit="return false;">','<div class="form-group">','<label class="col-sm-3 control-label">类型</label>','<div class="col-sm-8">','<input type="text" name="label" class="required" placeholder="请选择..." style="width:100%;">',"</div>","</div>",'<div class="form-group">','<label class="col-sm-3 control-label">属性</label>','<div class="col-sm-8">','<div class="propertylist">','<div class="propertyinfo" style="margin-bottom:8px;border:1px dashed rgba(255,255,255,0);">','<input type="text" name="propertykey" class="form-control block" placeholder="请选择..." style="width:45%;"/>&nbsp;-&nbsp;','<input type="text" name="propertyval" class="form-control block" placeholder="请输入..." style="width:45%;"/>&nbsp;','<span class="glyphicon glyphicon-plus propertyplus block disabled" title="增加"></span>',"</div>","</div>","</div>","</div>",'<div class="form-group">','<label class="col-sm-3 control-label">标注</label>','<div class="col-sm-8">','<textarea name="desc" class="form-control" placeholder="请填写..." style="height:100px;"></textarea>',"</div>","</div>","</form>"].join(""));var d=mining.mappingutils.getTypeList("entity"),e=['<div class="propertyinfo" style="margin-bottom:8px;border:1px dashed rgba(255,255,255,0);">','<input type="text" name="propertykey" class="block" placeholder="请选择..." style="width:45%;"/>&nbsp;-&nbsp;','<input type="text" name="propertyval" class="form-control block" placeholder="请输入..." style="width:45%;"/>&nbsp;','<span class="glyphicon glyphicon-plus propertyplus block" style="cursor:pointer;" title="增加"></span>',"</div>"].join(""),f=function(){var a=$(".propertylist",c).data("proData"),b=mining.utils.clone(a);$("[name=propertykey]",c).each(function(){var a=$(this).select2("data");mining.utils.isEmpty(a)?$(this).select2("val",b.shift().id):b.remove(a)}),$("[name=propertykey]",c).each(function(){var a=$(this).select2("data"),c=mining.utils.clone(b);c.splice(0,0,a),$(this).select2({data:c,dropdownCssClass:"artui-select2"}).on("change",f).select2("val",c[0].id)})};$("[name=label]",c).select2({data:function(){var a=[];return $.each(d,function(b,c){a.push({id:b,text:c})}),a}(),dropdownCssClass:"artui-select2"}).on("change",function(){var a=$(this).val(),d=mining.mappingutils.getLabel(a).name,f=mining.mappingutils.getProperties(a),g=[];$.each(f,function(a,b){g.push({id:a,text:b.name})});try{var h=mining.mapping.objList[a].key_mapping.split(",");$.each(h,function(a,b){if(!mining.utils.isEmpty(b)){var c=mining.mapping.propertyMapping[b];g.push({id:b,text:c.name})}})}catch(i){}$(".propertylist",c).data("proData",g).empty().append(e);var j=[];try{j=mining.mapping.objList[a].key_mapping.split(",")}catch(i){}b[d]&&(j=j.concat(b[d])),mining.utils.isEmpty(j)||mining.utils.isEmpty(j[0])?$("[name=propertykey]:last",c).select2({data:g,dropdownCssClass:"artui-select2"}).select2("val",g[0].id):$.each(j,function(a,b){$("[name=propertykey]:last",c).select2({data:g,dropdownCssClass:"artui-select2"}).select2("val",b).select2("enable",!1),$("[name=propertyval]:last",c).addClass("required"),a<j.length-1&&$(".propertylist",c).append(e)}),$(".propertyplus",c).not($(".propertyplus:first",c)).remove(),$("[name=propertykey]",c).size()>=g.length&&$(".propertyplus",c).addClass("disabled")}).on("select2-open",function(){$(this).siblings("label.error").remove()}),c.on("change","[name=propertykey]",function(){$(this).siblings("[name=propertyval]").val("")}),c.on("focus","[name=propertyval]",function(){$(this).removeClass("error")}),c.on("mouseover",".propertyplus,.propertyminus",function(){$(this).parent().css("border-color","rgba(255,255,255,0.5)")}).on("mouseout",".propertyplus,.propertyminus",function(){$(this).parent().css("border-color","rgba(255,255,255,0)")}).on("click",".propertyplus",function(){var a=$(".propertylist",c).data("proData"),b=$(this).parent(),d=$(e).append('<span class="glyphicon glyphicon-minus propertyminus" title="删除"></span>');window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),$(this).hasClass("disabled")||mining.utils.isEmpty(a)||($(".propertyplus",d).remove(),b.siblings().size()>0?b.siblings().last().after(d):b.after(d),$("[name=propertykey]",c).size()>=a.length&&$(this).addClass("disabled"),$("[name=propertykey]",d).select2({data:a,dropdownCssClass:"artui-select2"}),f())}).on("click",".propertyminus",function(){$(".propertyplus",c).removeClass("disabled"),$(this).parent().remove(),f()}),$(".propertylist",c).parent().mCustomScrollbar({theme:"minimal"}).css("max-height","300px")},okValue:"确定",ok:function(){var b=this,c=$(this.node),e=$("[name=label]",c).val(),f=$("[name=desc]",c).val().trim(),g={},h=[];if(mining.utils.isEmpty(e))return!1;if($("[name=propertykey]",c).each(function(){var a=$(this).val(),b=$(this).siblings("[name=propertyval]"),c=b.val().trim();return mining.utils.isEmpty(a)||mining.utils.isEmpty(c)?(b.hasClass("required")&&b.addClass("error"),void 0):(g[a]=c,h.push($(this).select2("data").text+"："+c),void 0)}),$("[name=propertyval].error",c).size()>0)return!1;var i=("custom_entity_"+mining.utils.randomInt(0,99999),mining.mapping.objList[e]);return $.extend(g,{type:i.type}),$ajax.ajax({url:a.addentity,type:"post",data:{user:mining.userinfo.user_id,label:i.label,description:f,properties:JSON.stringify(g)},success:function(a){$dialog.alert("添加实体成功！","success"),b.close().remove(),d.success&&d.success(a),mining.utils.serverLog(11,"实体名称："+i.type_name+"；属性："+h.join(","))},error:function(a){var b="添加实体失败，请稍后重试！";a.message&&!mining.utils.isEmpty(a.message)&&(b=a.message),$dialog.alert(b,"error"),d.error&&d.error(a)}}),!1},cancelValue:"取消",cancel:!0,onclose:function(){$(".main").removeClass("blur")}}).showModal()},f=function(d){var e=$.extend({from:null,to:null,success:null,error:null},d),f=[];if(mining.utils.isEmpty(e.from)||mining.utils.isEmpty(e.to))return $dialog.alert("请选择至少 2 个实体！","warning"),void 0;mining.utils.isEmpty(c)&&g(),$.each(c,function(a,b){-1!=b.labels.indexOf(e.from.label)&&-1!=b.labels.indexOf(e.to.label)&&f.push({id:b.id,text:b.name})});try{mining.mapping.objList.custom_relation_other&&f.pushOnly({id:"custom_relation_other",text:"自定义关系"})}catch(h){}$dialog({title:"添加关系",width:500,padding:"20px 0 0",onshow:function(){var a=this,c=$(this.node);$(".main").addClass("blur"),a.content(['<form class="form-horizontal required-validate" onsubmit="return false;">','<div class="form-group">','<label class="col-sm-3 control-label">名称</label>','<div class="col-sm-8">','<input type="text" name="relation" class="required" placeholder="请选择..." style="width:100%;">',"</div>","</div>",'<div class="form-group">','<label class="col-sm-3 control-label">属性</label>','<div class="col-sm-8">','<div class="propertylist">','<div class="propertyinfo" style="margin-bottom:8px;border:1px dashed rgba(255,255,255,0);">','<input type="text" name="propertykey" class="form-control block" placeholder="请选择..." style="width:45%;"/>&nbsp;-&nbsp;','<input type="text" name="propertyval" class="form-control block" placeholder="请输入..." style="width:45%;"/>&nbsp;','<span class="glyphicon glyphicon-plus propertyplus block disabled" title="增加"></span>',"</div>","</div>","</div>","</div>",'<div class="form-group">','<label class="col-sm-3 control-label">标注</label>','<div class="col-sm-8">','<textarea name="desc" class="form-control" placeholder="请填写..." style="height:100px;"></textarea>',"</div>","</div>","</form>"].join(""));var d=['<div class="propertyinfo" style="margin-bottom:8px;border:1px dashed rgba(255,255,255,0);">','<input type="text" name="propertykey" class="block" placeholder="请选择..." style="width:45%;"/>&nbsp;-&nbsp;','<input type="text" name="propertyval" class="form-control block" placeholder="请输入..." style="width:45%;"/>&nbsp;','<span class="glyphicon glyphicon-plus propertyplus block" style="cursor:pointer;" title="增加"></span>',"</div>"].join(""),e=function(){var a=$(".propertylist",c).data("proData"),b=mining.utils.clone(a);$("[name=propertykey]",c).each(function(){var a=$(this).select2("data");mining.utils.isEmpty(a)?$(this).select2("val",b.shift().id):b.remove(a)}),$("[name=propertykey]",c).each(function(){var a=$(this).select2("data"),c=mining.utils.clone(b);c.splice(0,0,a),$(this).select2({data:c,dropdownCssClass:"artui-select2"}).on("change",e).select2("val",c[0].id)})};$("[name=relation]",c).select2({data:f,dropdownCssClass:"artui-select2"}).on("change",function(){var a=$("[name=relation]",c).val(),e=mining.mappingutils.getLabel(a).name,f=mining.mappingutils.getProperties(a),g=[];$.each(f,function(a,b){mining.utils.isEmpty(b)||g.push({id:a,text:b.name})}),$(".propertylist",c).data("proData",g).empty().append(d);var h=[];b[e]&&(h=h.concat(b[e])),mining.utils.isEmpty(h)||mining.utils.isEmpty(h[0])?$("[name=propertykey]:last",c).select2({data:g,dropdownCssClass:"artui-select2"}).select2("val",g[0].id):$.each(h,function(a,b){$("[name=propertykey]:last",c).select2({data:g,dropdownCssClass:"artui-select2"}).select2("val",b).select2("enable",!1),$("[name=propertyval]:last",c).addClass("required"),a<h.length-1&&$(".propertylist",c).append(d)}),$(".propertyplus",c).not($(".propertyplus:first",c)).remove(),$("[name=propertykey]",c).size()>=g.length&&$(".propertyplus",c).addClass("disabled")}),c.on("change","[name=propertykey]",function(){$(this).siblings("[name=propertyval]").val("")}),c.on("focus","[name=propertyval]",function(){$(this).removeClass("error")}),c.on("mouseover",".propertyplus,.propertyminus",function(){$(this).parent().css("border-color","rgba(255,255,255,0.5)")}).on("mouseout",".propertyplus,.propertyminus",function(){$(this).parent().css("border-color","rgba(255,255,255,0)")}).on("click",".propertyplus",function(){var a=$(".propertylist",c).data("proData"),b=$(this).parent(),f=$(d).append('<span class="glyphicon glyphicon-minus propertyminus" title="删除"></span>');window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),$(this).hasClass("disabled")||mining.utils.isEmpty(a)||($(".propertyplus",f).remove(),b.siblings().size()>0?b.siblings().last().after(f):b.after(f),$("[name=propertykey]",c).size()>=a.length&&$(this).addClass("disabled"),$("[name=propertykey]",f).select2({data:a,dropdownCssClass:"artui-select2"}),e())}).on("click",".propertyminus",function(){$(".propertyplus",c).removeClass("disabled"),$(this).parent().remove(),e()}),$(".propertylist",c).parent().mCustomScrollbar({theme:"minimal"}).css("max-height","300px")},okValue:"确定",ok:function(){var b=this,c=$(this.node);if(labelname=$("[name=relation]",c).val(),desc=$("[name=desc]",c).val().trim(),proData={from_id:e.from.gid,to_id:e.to.gid},proStrArr=["form-"+e.from.key,"to-"+e.to.key],nodedata={e:[],v:[]},mining.utils.isEmpty(labelname))return!1;if($("[name=propertykey]",c).each(function(){var a=$(this).val(),b=$(this).siblings("[name=propertyval]"),c=b.val().trim();return mining.utils.isEmpty(a)||mining.utils.isEmpty(c)?(b.hasClass("required")&&b.addClass("error"),void 0):(proData[a]=c,proStrArr.push($(this).select2("data").text+"："+c),void 0)}),$("[name=propertyval].error",c).size()>0)return!1;var d=("custom_relation_"+mining.utils.randomInt(0,99999),mining.mapping.objList[labelname]);return $.extend(proData,{type:d.type}),$ajax.ajax({url:a.addrelation,type:"post",data:{user:mining.userinfo.user_id,label:d.label,description:desc,properties:JSON.stringify(proData)},success:function(a){$dialog.alert("添加关系成功！","success"),b.close().remove(),e.success&&e.success(a),mining.utils.serverLog(11,"关系名称："+d.type_name+"；属性："+proStrArr.join(","))},error:function(a){var b="添加关系失败，请稍后重试！";a.message&&!mining.utils.isEmpty(a.message)&&(b=a.message),$dialog.alert(b,"error"),e.error&&e.error(a)}}),!1},cancelValue:"取消",cancel:!0,onclose:function(){$(".main").removeClass("blur")}}).showModal()},g=function(){var a=mining.mappingutils.getTypeList("relation");try{delete a.harts,delete a.noharts}catch(b){}$.each(a,function(a,b){var d=mining.mapping.objList[a];mining.utils.isEmpty(d.subject_label)||mining.utils.isEmpty(d.object_label)||c.push({id:a,name:b,labels:[d.subject_label,d.object_label]})})},h=function(b){var c=$.extend({id:"",type:"entity",success:null,error:null},b),d="实体",e=a.delentity;mining.utils.isEmpty(c.id)||("relation"==c.type&&(d="关系",e=a.delrelation),$dialog.confirm({title:"删除"+d,content:'您确定要&nbsp;<b class="red">删除该'+d+"</b>&nbsp;吗？",ok:function(){var a=this;return $ajax.ajax({url:e,data:{user:mining.userinfo.user_id,id:c.id},success:function(a){$dialog.alert("删除"+d+"成功！","success"),c.success&&c.success(a)},error:function(a){mining.utils.alert("删除"+d+"失败，请稍后重试！","error"),c.error&&c.error(a)},complete:function(){a.close().remove()}}),!1}}))},i=function(){};return{add:d,del:h,list:i}});
