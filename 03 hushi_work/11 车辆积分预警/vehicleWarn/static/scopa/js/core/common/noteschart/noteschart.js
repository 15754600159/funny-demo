define("scopa/core/common/noteschart/noteschart",[],function(a,b,c){c.exports=function(){var a={readyCallback:null,selectCallback:null,resizeCallback:null,clickCallback:null,dblclickCallback:null,dataCallback:null},b={getAllNotes:mining.baseurl.core+"/note/listAllByItemId",insertNote:mining.baseurl.core+"/note/insert",delNote:mining.baseurl.core+"/note/deleteById",updateNote:mining.baseurl.core+"/note/updateById",existList:mining.baseurl.core+"/note/existList"},c=mining.userinfo.user_id,d=mining.userinfo.name,e=function(a,b){function d(a){var b=['<span class="item-btns pull-right">',1==a?'<span class="share-btn share" title="分享"></span>':'<span class="share-btn cancel-share" title="取消分享"></span>','<span class="scopaicon scopaicon-baocun btn-save'+("insert"==f?"":" hidden")+'" title="保存"></span>','<span class="scopaicon scopaicon-shanchuxiao del-note" title="删除"></span>',"</span>"];return b.join("")}switch(a){case"note":var f=b.noteType||"show",g=b.listObj||[];if(noteInfoArr=[],mining.utils.isEmpty(g)){var h={noteType:f,item:{},isMine:!0};noteInfoArr.push(e("noteDetails",h))}else $.each(g,function(a,b){var d=c==b.userId?!0:!1,g={noteType:f,item:b,isMine:d};noteInfoArr.push(e("noteDetails",g))});return['<i class="note-icon" data-gid="'+b.dataId+'" data-etype="'+b.dataType+'"></i>','<div class="notes-main" data-gid="'+b.dataId+'">','<div class="note-bar">',"add"==f?"":'<span class="total pull-left">共<span class="count">'+g.length+"</span>条</span>",'<span class="btns pull-right">',"add"==f?'<span class="share-btn share" title="分享"></span>':"",'<span class="scopaicon scopaicon-guanbi close-tip" title="关闭"></span>',"</span>","</div>",'<div class="note-panel">',"show"==f?e("addNote"):"",'<div class="note-list">','<div class="note-list-box">',noteInfoArr.join(""),"</div>","</div>","add"==f?e("addBottom"):"","</div>","</div>"].join("");case"addNote":return'<div class="add-note"><span class="btn-current btn-note btn-add">添加便签</span></div>';case"addBottom":return'<div class="add-note-bottom"><span class="btn-current btn-note btn-save">确定</span></div>';case"noteDetails":var i=b.isMine,j=b.item,f=b.noteType,k=[];return"add"!=f&&(k=['<div class="note-base">','<span class="user-name ellipsis'+("insert"==f?" narrow":"")+' pull-left" data-user-id="'+(j.userId||"")+'"'+(i?"":' style="width:100%;"')+">",'<span title="'+(j.userName||"")+'">'+(j.userName||"")+"</span>",i?'<i class="scopaicon scopaicon-wode"></i>':"",'<span class="note-time" title="'+(j.time?mining.utils.dateFormat(new Date(j.time),"yyyy-MM-dd hh:mm:ss"):"")+'">'+(j.time?mining.utils.dateFormat(new Date(j.time),"yyyy-MM-dd hh:mm:ss"):"")+"</span>","</span>",i?d(j.authority):"","</div>"]),['<div class="item-note" data-status="'+f+'" data-note-id="'+(j.id||"")+'">',k.join(""),'<div class="note-details">','<div class="note-info-show'+(i?"":" readonly")+'">','<span class="note-info">'+(j.note||"")+"</span>",'<span class="cursor-blink"></span>','<span class="prompt-info">'+(j.note?"":"请输入100字以内")+"</span>","</div>",'<textarea value="'+(j.note||"")+'" '+("show"!=f?'placeholder="请输入100字以内"':"")+' maxlength="100" '+(i?"":"readonly")+">"+(j.note||"")+"</textarea>","</div>","</div>"].join("")}},f=function(b){$.extend(a,b)},g=function(a){$.fn.qtip.zindex=2e3,a.node.qtip({content:{text:function(){return a.tplHtml}},position:{my:"top center",at:"bottom center",container:$(".page-graph")},style:{classes:"notes-box",width:"298px",height:"304px",tip:{corner:!1}},show:{ready:!0,event:!1},hide:{event:!1},events:{render:function(a,b){k(b)}}})},h=function(a){j({dataId:a.gid,callback:function(b){var c={dataId:a.gid,dataType:a.etype,noteType:"show",listObj:b.listObj},d=e("note",c);g({node:a.element,tplHtml:d})}})},i=function(a){var b={dataId:a.gid,dataType:a.etype,noteType:"add"},c=e("note",b);g({node:a.element,tplHtml:c})},j=function(a){s({url:b.getAllNotes,param:{itemId:a.dataId},msg:"获取便签列表",callback:a.callback,async:!0})},k=function(b){var f=1,g="",h=b.elements.content,i=100,j=0,k=3e3,n=setInterval(function(){$(h).find(".note-list").size()>0||j>k?(clearInterval(n),$(h).find(".note-list").mCustomScrollbar({theme:"minimal"})):j+=i},i);$(h).off("click",".note-bar .close-tip").on("click",".note-bar .close-tip",function(a){b.hide(a),b.destroy()}),$(h).off("click",".add-note .btn-add").on("click",".add-note .btn-add",function(){var a={noteType:"insert",item:{userId:c,userName:d,authority:1},isMine:!0},b=e("noteDetails",a);$(this).parent().addClass("hidden"),$(h).find(".note-list").height("100%").find(".note-list-box").prepend(b)}),$(h).off("click",".notes-main .share").on("click",".notes-main .share",function(){var a=$(this).parents(".item-note:first");if("show"==a.attr("data-status")){var b=a.attr("data-note-id"),c={id:b,authority:0},d={param:c,msg:"设置便签公有化",callback:function(){a.find(".share").removeClass("share").addClass("cancel-share").attr("title","取消分享"),l(a,h)}};p(d)}else f=0,$(this).removeClass("share").addClass("cancel-share").attr("title","取消分享");mining.utils.serverLog(78)}),$(h).off("click",".notes-main .cancel-share").on("click",".notes-main .cancel-share",function(){var a=$(this).parents(".item-note:first");if("show"==a.attr("data-status")){var b=a.attr("data-note-id"),c={id:b,authority:1},d={param:c,msg:"设置便签私有化",callback:function(){a.find(".cancel-share").removeClass("cancel-share").addClass("share").attr("title","分享"),l(a,h)}};p(d)}else f=1,$(this).removeClass("cancel-share").addClass("share").attr("title","分享")}),$(h).off("click",".item-btns .del-note").on("click",".item-btns .del-note",function(){var b=$(this).parents(".item-note:first"),c=b.attr("data-note-id");"show"==b.attr("data-status")?$dialog.confirm({title:"删除便签",content:"您确定要删除该便签信息吗？",ok:function(){var d={param:{id:c},callback:function(){a.dataCallback(c),b.remove(),$(h).find(".total .count").text($(h).find(".note-list-box .item-note").size())}};o(d),mining.utils.serverLog(79)}}):(b.remove(),$(h).find(".add-note").removeClass("hidden"))}),$(h).off("click",".item-note .btn-save").on("click",".item-note .btn-save",function(){var a=$(this).parents(".item-note:first"),c=a.find("textarea").val(),d=$(h).find(".note-icon"),e=d.attr("data-gid"),g=d.attr("data-etype");if(c.length>100)return $dialog.alert("便签内容长度不能超过100，请重新输入"," warning"),void 0;if("show"==a.attr("data-status")){var i=a.attr("data-note-id"),j={id:i,note:c},k={param:j,msg:"更新便签内容",callback:function(){a.find(".btn-save").addClass("hidden"),a.find(".user-name").removeClass("narrow"),l(a,h)}};p(k)}else{var k={dataId:e,etype:g,noteTxt:c,isShare:f,tipDom:b,isNew:!1};m(k),mining.utils.serverLog(77,c)}}),$(h).off("click",".add-note-bottom .btn-save").on("click",".add-note-bottom .btn-save",function(){var a=$(h).find(".item-note"),c=a.find("textarea").val(),d=$(h).find(".note-icon"),e=d.attr("data-gid"),g=d.attr("data-etype"),i={dataId:e,etype:g,noteTxt:c,isShare:f,tipDom:b,isNew:!0};return c.length>100?($dialog.alert("便签内容长度不能超过100，请重新输入","warning"),void 0):(m(i),mining.utils.serverLog(77,c),void 0)}),$(h).on("focus",".note-details textarea",function(){var a=$(this).parents(".item-note:first");a.find(".btn-save").hasClass("hidden")&&(g=$(this).val()),a.find(".btn-save").removeClass("hidden"),a.find(".user-name").addClass("narrow")}).on("keyup",".note-details textarea",function(){mining.utils.isEmpty($(this).val())?$(this).parent().find(".note-info-show").find(".note-info").empty().parent().find(".prompt-info").text("请输入100字以内"):$(this).val().length>=100?$dialog.alert("便签输入内容长度已达上限，内容长度需小于100","warning",2e3):$(this).parent().find(".note-info-show").find(".prompt-info").empty().parent().find(".note-info").text($(this).val())}).on("blur",".note-details textarea",function(){var a=$(this).parents(".item-note:first");"show"==a.attr("data-status")&&g==$(this).val()&&(a.find(".btn-save").addClass("hidden"),a.find(".user-name").removeClass("narrow"))}),$(h).off("click",".note-details .note-info-show").on("click",".note-details .note-info-show",function(){$(this).parent().find("textarea").focus()})},l=function(a,b){var c=mining.utils.dateFormat(new Date,"yyyy-MM-dd hh:mm:ss");a.find(".note-time").attr("title",c).text(c);var d=a.clone();a.remove(),$(b).find(".note-list").find(".note-list-box").prepend(d)},m=function(b){if(mining.utils.isEmpty(b.noteTxt))return $dialog.alert("便签内容不能为空","warning"),void 0;var d={itemId:b.dataId,type:"node"!=b.etype?1:0,userId:c,note:b.noteTxt,authority:b.isShare},f={param:d,callback:function(){b.isNew&&a.dataCallback(d.itemId),j({dataId:b.dataId,callback:function(a){var c={dataId:b.dataId,dataType:b.etype,noteType:"show",listObj:a.listObj},d=e("note",c);b.tipDom.set("content.text",d)}})}};n(f)},n=function(a){s({url:b.insertNote,param:a.param,msg:"添加便签",showMsg:!0,callback:a.callback,type:"post",async:!0})},o=function(a){s({url:b.delNote,param:a.param,msg:"删除便签",type:"post",callback:a.callback})},p=function(a){s({url:b.updateNote,param:a.param,msg:a.msg,showMsg:!0,callback:a.callback,type:"post",async:!0})},q=function(a){a?$.each(a,function(a,b){$('.notes-box .notes-main[data-gid="'+b+'"] .close-tip').click()}):$(".notes-box .notes-main .close-tip").click()},r=function(a){0!=a.dataIds.length&&s({url:b.existList,param:{itemIds:a.dataIds.join(",")},type:"post",msg:"获取列表",callback:a.callback,async:a.async})},s=function(a){$ajax.ajax({url:a.url,data:a.param,type:a.type||"get",async:a.async,success:function(b){a.showMsg&&$dialog.alert(a.msg+"成功","success"),a.callback&&a.callback(b)},error:function(){$dialog.alert(a.msg+"失败","error")}})};return{init:f,show:h,add:i,close:q,isNoted:r}}});
