define("scopa/core/graph/graphmenu/graphmenu",["app/mygraph/testdata"],function(a){var b,c,d,e,f,g={graphModule:null,graph:null,container:null,callback:null},h={getByLabel:mining.baseurl.core+"/query/getByLabel",getByHop:mining.baseurl.core+"/query/getByHop",getPath:mining.baseurl.core+"/query/getPath",expandEdge:mining.baseurl.core+"/query/expandEdge",getEvents:mining.baseurl.core+"/archive/getEventsByType",merge:mining.baseurl.core+"/query/merge",getrule:mining.baseurl.console+"/rule/get"},i=null,j=[],k=!1,l=1e3,m=function(e){if(!($("#graphMenu").size()>0)){e=e||{};for(var h in e)e[h]=e[h]||g[h];i=e.graph,b=e.graphModule,c=e.eventModule,d=e.notesModule;var j="string"==typeof e.container?$(e.container):e.container;j.size()<1||($ajax.ajax({url:staticUrl+"/scopa/template/core/graphmenu.html",async:!1,success:function(a){$("body").append(a)}}),o(),f=mining.mappingutils.getHartsList(),a.async("./contextmenu",function(){j.contextMenu("dragon",{onShowMenu:function(a,b){if($ajax.ajax({url:staticUrl+"/scopa/template/core/graphmenu.html",async:!1,success:function(a){$("#graphMenu").remove(),$("body").append(a),b=$("#graphMenu"),o()}}),i.$(":selected").length<1&&i.$(".mouseover").length>0&&!i.$(".mouseover").selected()&&(i.$(":selected").unselect(),i.$(".mouseover").first().select()),$(".disabled",b).removeClass("disabled"),i.$(":selected").length>0){var c=i.nodes(".entity:selected").length,d=(i.nodes(".event:selected").length,i.edges(".relation:selected").length),e=!0;if($.each(i.nodes(":selected"),function(a,b){return-1==b.data().name.indexOf("*")?(e=!1,!1):void 0}),1>c?$(".graphmenu-expand-entity,.graphmenu-expand-event,.graphmenu-expand-relation",b).addClass("disabled"):2>c&&$(".graphmenu-expand-relation",b).addClass("disabled"),2!=c&&$(".graphmenu-compare-event",b).addClass("disabled"),1==c){var f=i.nodes(".entity:selected").data().data.key;f&&-1==f.indexOf("*")||$(".graphmenu-expand-entity,.graphmenu-expand-event,.graphmenu-expand-relation",b).addClass("disabled")}}else $(".graphmenu-delete-other",b).siblings().addClass("disabled");return n(b),0==c&&0==d?($("[action=view-file]",b).parent().hide(),$("[action=view-map]",b).parents("li:first").transform("rotate(105deg) skew(60deg)"),$("[action=view-map] span",b).transform("rotate(-100deg)")):($("[action=view-file]",b).parent().show(),$("[action=view-map]",b).parents("li:first").transform("rotate(90deg) skew(60deg)"),$("[action=view-map] span",b).transform("rotate(-115deg)")),b},bindings:{"expand-entity":function(a){if(!(i.nodes(":selected").length<1)){var b=a.attr("param"),c=i.nodes(".entity:selected");k=!1,"more"==b?(q(c),mining.utils.serverLog(31)):"special"==b?(t(c),mining.utils.serverLog(32)):(mining.utils.modalLoading(),$.each(c,function(a,c){var d=c.data().data;setTimeout(function(){p(d,"all"==b?[]:[b])},300)}),"all"==b?mining.utils.serverLog(29):"harts"==b&&mining.utils.serverLog(30))}},"expand-event":function(a){if(!(i.nodes(":selected").length<1)){var b=a.attr("param"),c=i.nodes(".entity:selected");"more"==b?(s(c),mining.utils.serverLog(34)):"special"==b?(u(),mining.utils.serverLog(35)):(mining.utils.modalLoading(),$.each(c,function(a,c){var d=c.data().data;setTimeout(function(){r(d,"all"==b?[]:[b])},300)}),mining.utils.serverLog(33))}},"expand-relation":function(a){var b=a.attr("param"),c=[];$.each(i.nodes("node.entity:selected"),function(a,b){c.push(b.data().id)}),c.length<2||("special"!=b?(v(c,[]),mining.utils.serverLog(36)):(w(c),mining.utils.serverLog(37)))},"view-graph":function(){y("graph")},"view-map":function(){y("map"),mining.utils.serverLog(38)},"view-ticket":function(){z(),mining.utils.serverLog(39)},"view-file":function(){y("file"),mining.utils.serverLog(40)},select:function(){b.refresh()},"assist-lock":function(a){if(!(i.nodes(":selected").length<1)){var b=a.attr("param"),c=i.nodes(".entity:selected"),d=13;"lock"==b?c.lock():(c.unlock(),d=14),mining.utils.saveGraphHistory(i);try{var e=[];$.each(c,function(a,b){e.push(b.data().name)}),mining.utils.serverLog(d,e.join(","))}catch(f){}}},"assist-notes":function(){var a=i.nodes(".entity:selected");if(!(a.length<1)){if(1==a.length){var b=a.data().data;a.data().noted?(mining.utils.modalLoading(),d.show({gid:b.gid,element:a,etype:"node"}),mining.utils.serverLog(41,"查看便签："+a.data().name)):(d.add({gid:b.gid,element:a,etype:"node"}),mining.utils.serverLog(41,"添加便签："+a.data().name))}else $dialog.alert("请选择单个实体！","warning",1e3);setTimeout(function(){mining.utils.modalLoading("close")},300*a.length)}},"delete":function(){b.delelements(":selected"),mining.utils.serverLog(42)},"delete-other":function(){b.delelements(":unselected"),mining.utils.serverLog(43)},"compare-event":function(){x(),mining.utils.serverLog(44)}}})}))}},n=function(a){var b=i.nodes(".entity:selected");if(a.find("[action][param]").not(a.find("[action][param=all],[action][param=more],[action][param=special],[action^=assist]")).each(function(){$(this).parent().remove()}),b.length>0){var c=mining.mappingutils.getMenu(b.data().data);i.$(".entity.person:selected,.entity.passport:selected").length>0&&a.find("[action=expand-entity][param=all]").parents("li:first").after('<li><a href="javascript:;" action="expand-entity" param="harts"><span>隐性关系</span></a></li>'),$.each(c,function(b,c){var d=a.find("[action=expand-"+b+"][param=all]").parents("ul");$.each(c,function(a,c){d.append('<li><a href="javascript:;" action="expand-'+b+'" param="'+c.name+'"><span>'+c.label+"</span></a></li>"),$("[param=more]",d).size()>0&&$("[param=more]",d).parent().appendTo(d),$("[param=special]",d).size()>0&&$("[param=special]",d).parent().appendTo(d)})}),i.$(".entity.phoneNO:selected").length<1?a.find("[action=view-ticket]").parent().remove():$("[action=view-ticket]",a).size()<1&&a.find("[action=view-map]").parent().after('<li><a href="javascript:;" action="view-ticket"><span>话单</span></a></li>');var d="查看便签",e="show";if(b.length>0){var f=!1;$.each(b,function(a,b){return b.data().noted?(f=!0,!1):void 0})}if(b.data().noted||(d="添加便签",e="add"),a.find("[action=assist-notes]").attr("param",e).find("span").text(d),d="解锁",e="unlock",b.length>0){var g=!1;$.each(b,function(a,b){return b.locked()?(g=!0,!1):void 0})}b.locked()&&g||(d="锁定",e="lock"),a.find("[action=assist-lock]").attr("param",e).find("span").text(d),o()}},o=function(){$(".graphmenu .graphmenu-sub").each(function(a){var b=90,c=30,d=60,e=45*a-30*$(this).find("li").size()/2;$(this).find("li").each(function(a){$(this).transform("rotate("+(b+a*c)+"deg) skew("+d+"deg)"),$(this).find("span").transform("rotate("+-(100+e-b+a*c)+"deg)"),$(this).find("span").text().length>4&&$(this).find("span").width(52)}),$(this).transform("rotate("+e+"deg)")})};$(document).off("keydown.graphmenu").on("keydown.graphmenu",function(a){a.keyCode==mining.keyCode.DELETE&&-1!=$.hash().indexOf("graph")&&(b.delelements(":selected"),c.delelements(":selected"))});var p=function(c,d,g,j,m,n){console.time("***ExpandEntity");var o=mining.mappingutils.getClassList("relation"),q={},r=[];if(d=d||[],g=g||"",j=j||"",m=m||"",n=n||!1,mining.utils.isEmpty(d)&&(d=[],$.each(o,function(a,b){d.push(b.label)})),$.each(d,function(a,b){try{var c=o[b].children[0].type;q[b]=mining.mapping.objList[b+(mining.utils.isEmpty(c)?"":"_"+c)].timeline}catch(d){}}),!k){$.each(f,function(a,b){-1!=d.indexOf(a)&&(r.push(b.id),delete q[a],q.harts="time_list")});try{clearTimeout(e)}catch(s){}e=setTimeout(mining.utils.modalLoading,l),console.time("ajax-getEntityData");var t=a("../testdata");if(16608==c.gid&&t){b.appenddata(t);try{clearTimeout(e),mining.utils.modalLoading("close")}catch(s){}}else $ajax.ajax({url:h.getByLabel,data:{vid:c.gid,labels:JSON.stringify(q),starttime:g,endtime:j,rule_ids:JSON.stringify(r),keyword:m},type:"get",success:function(a){console.timeEnd("ajax-getEntityData");try{clearTimeout(e),mining.utils.modalLoading("close")}catch(d){}return mining.utils.isEmpty(a)?($dialog.alert("未找到任何数据！","warning"),void 0):(b.appenddata(a),n||setTimeout(function(){var a=i.$("#"+c.gid),b=a.data().data;"person"==b.label&&($.each(a.neighborhood(".entity"),function(a,b){var c=b.data().data;b.hasClass("entity")&&("case"==c.label||"household"==c.label&&"community_household"!=c.type)&&p(c)}),k=!0)},300),void 0)},error:function(a){console.timeEnd("ajax-getEntityData");try{clearTimeout(e),mining.utils.modalLoading("close")}catch(b){}mining.utils.alertMsg(a,"获取数据失败，请稍后重试！","error")}})}},q=function(a){$dialog({title:"条件扩展",width:530,onshow:function(){var a=this,b=$(this.node),c=mining.mappingutils.getClassList("relation"),d="";$(".main").addClass("blur"),d+='<div class="col-sm-6"><a class="chooseall" href="javascript:;" style="color:#707070;"><span class="checkbox"></span>全部</a></div>',$.each(c,function(a,b){"harts"!=b.label?d+='<div class="col-sm-6"><a class="chooselabel" href="javascript:;" label="'+b.label+'" style="color:#707070;"><span class="checkbox"></span>'+b.label_name+"</a></div>":$.each(f,function(a,b){d+='<div class="col-sm-6"><a class="chooselabel" href="javascript:;" label="'+a+'" style="color:#707070;"><span class="checkbox"></span>'+b.name+"</a></div>"})}),a.content(['<form class="form-horizontal required-validate" onsubmit="return false;">','<div class="form-group">','<label class="col-sm-2 control-label">关系类型</label>','<div class="col-sm-9">'+d+"</div>","</div>",'<div class="form-group">','<label class="col-sm-2 control-label">时间范围</label>','<div class="col-sm-9">','<input type="text" name="timerange" class="form-control" placeholder="请选择...">',"</div>","</div>",'<div class="form-group">','<label class="col-sm-2 control-label">关键字</label>','<div class="col-sm-9">','<input type="text" name="keyword" class="form-control" placeholder="请填写...">',"</div>","</div>","</form>"].join("")),$(".chooselabel",b).on("click",function(){var a=$(this);a.add($(".checkbox",a)).toggleClass("active")}),$(".chooseall",b).on("click",function(){var a=$(this);a.toggleClass("active"),a.hasClass("active")?$(".chooselabel,.checkbox",b).addClass("active"):$(".chooselabel,.checkbox",b).removeClass("active")}),$("[name=timerange]",b).daterangepicker({timePicker:!0,timePicker12Hour:!1,timePickerIncrement:1,showDropdowns:!0,format:"YYYY-MM-DD HH:mm:ss",applyClass:"btn-primary",clearClass:"btn-primary"}).on("clear.daterangepicker",function(){$(this).val("")})},okValue:"确定",ok:function(){var b=$(this.node),c=[],d=$("[name=timerange]",b).val().split(" 至 "),e=$("[name=keyword]",b).val();$(".chooselabel.active",b).each(function(){c.push($(this).attr("label"))}),c.length<1&&$(".chooselabel",b).each(function(){c.push($(this).attr("label"))}),d.length<2&&(d=["",""]),mining.utils.isEmpty(c)||$.each(a,function(a,b){var f=b.data().data;setTimeout(function(){p(f,c,d[0],d[1],e,!0)},300)})},cancelValue:"取消",cancel:!0,onclose:function(){$(".main").removeClass("blur")}}).showModal()},r=function(a,b,d,f,g){console.time("***ExpandEvent");var i=mining.mappingutils.getProperties(a,"key");b=b||[],d=d||"",f=f||"",g=g||"",mining.utils.isEmpty(b)&&(b=mining.mappingutils.getLabels("event"));try{clearTimeout(e)}catch(j){}e=setTimeout(mining.utils.modalLoading,l),console.time("ajax-getEventData"),$ajax.ajax({url:h.getEvents,data:{objId:i.value,types:JSON.stringify(b),starttime:d,endtime:f,keyword:g,areaID:mining.userinfo.targetAreaId},success:function(b){if(console.timeEnd("ajax-getEventData"),mining.utils.isEmpty(b.bodyData)){try{clearTimeout(e),mining.utils.modalLoading("close")}catch(d){}return $dialog.alert("未找到任何数据！","warning"),void 0}c.appenddata(a,b.bodyData),c.highlight(a,b.targetArea);try{clearTimeout(e),mining.utils.modalLoading("close")}catch(d){}},error:function(a){console.timeEnd("ajax-getEventData");try{clearTimeout(e),mining.utils.modalLoading("close")}catch(b){}mining.utils.alertMsg(a,"获取数据失败，请稍后重试！","error")}})},s=function(a){$dialog({title:"条件扩展",width:530,onshow:function(){var a=this,b=$(this.node),c=mining.mappingutils.getClassList("event"),d="";$(".main").addClass("blur"),d+='<div class="col-sm-6"><a class="chooseall" href="javascript:;" style="color:#707070;"><span class="checkbox"></span>全部</a></div>',$.each(c,function(a,b){d+='<div class="col-sm-6"><a class="chooselabel" href="javascript:;" label="'+b.label+'" style="color:#707070;"><span class="checkbox"></span>'+b.label_name+"</a></div>"}),a.content(['<form class="form-horizontal required-validate" onsubmit="return false;">','<div class="form-group">','<label class="col-sm-2 control-label">关系类型</label>','<div class="col-sm-9">'+d+"</div>","</div>",'<div class="form-group">','<label class="col-sm-2 control-label">时间范围</label>','<div class="col-sm-9">','<input type="text" name="timerange" class="form-control" placeholder="请选择...">',"</div>","</div>",'<div class="form-group">','<label class="col-sm-2 control-label">关键字</label>','<div class="col-sm-9">','<input type="text" name="keyword" class="form-control" placeholder="请填写...">',"</div>","</div>","</form>"].join("")),$(".chooselabel",b).on("click",function(){var a=$(this);a.add($(".checkbox",a)).toggleClass("active")}),$(".chooseall",b).on("click",function(){var a=$(this);a.toggleClass("active"),a.hasClass("active")?$(".chooselabel,.checkbox",b).addClass("active"):$(".chooselabel,.checkbox",b).removeClass("active")}),$("[name=timerange]",b).daterangepicker({timePicker:!0,timePicker12Hour:!1,showDropdowns:!0,timePickerIncrement:1,format:"YYYY-MM-DD HH:mm:ss",applyClass:"btn-primary",clearClass:"btn-primary"}).on("clear.daterangepicker",function(){$(this).val("")})},okValue:"确定",ok:function(){var b=$(this.node),c=[],d=$("[name=timerange]",b).val().split(" 至 "),e=$("[name=keyword]",b).val();$(".chooselabel.active",b).each(function(){c.push($(this).attr("label"))}),c.length<1&&$(".chooselabel",b).each(function(){c.push($(this).attr("label"))}),d.length<2&&(d=["",""]),mining.utils.isEmpty(c)||$.each(a,function(a,b){var f=b.data().data;setTimeout(function(){r(f,c,d[0],d[1],e)},300)})},cancelValue:"取消",cancel:!0,onclose:function(){$(".main").removeClass("blur")}}).showModal()},t=function(a){b.closeentity(a)},u=function(){var a=[];$.each(i.$(".entity:selected"),function(b,c){a.push(c.data().data)}),c.closeevent(a)},v=function(a,c,d,g,i){var j=[];c=c||[],d=d||2,g=g||"",i=i||!1,mining.utils.isEmpty(c)&&(c=mining.mappingutils.getLabels("relation")),$.each(f,function(a,b){-1!=c.indexOf(a)&&(j.push(b.id),c.remove(a),c.pushOnly("harts"))});try{clearTimeout(e)}catch(k){}e=setTimeout(mining.utils.modalLoading,l),console.time("ajax-getRelationData"),$ajax.ajax({url:h.getPath,data:{vids:JSON.stringify(a),labels:JSON.stringify(c),rule_ids:JSON.stringify(j),hop:d,keyword:g},success:function(a){console.timeEnd("ajax-getRelationData");try{clearTimeout(e),mining.utils.modalLoading("close")}catch(c){}return!mining.utils.isEmpty(a)&&!mining.utils.isEmpty(a.v)||i?(b.appenddata(a),void 0):($dialog.alert("未找到任何数据！","warning"),void 0)},error:function(a){console.timeEnd("ajax-getRelationData");try{clearTimeout(e),mining.utils.modalLoading("close")}catch(b){}i||mining.utils.alertMsg(a,"获取数据失败，请稍后重试！","error")}})},w=function(a){$dialog({title:"条件推演",width:530,onshow:function(){var a=this,b=$(this.node),c=mining.mappingutils.getClassList("relation"),d="";$(".main").addClass("blur"),d+='<div class="col-sm-6"><a class="chooseall" href="javascript:;" style="color:#707070;"><span class="checkbox"></span>全部</a></div>',$.each(c,function(a,b){"harts"!=b.label?d+='<div class="col-sm-6"><a class="chooselabel" href="javascript:;" label="'+b.label+'" style="color:#707070;"><span class="checkbox"></span>'+b.label_name+"</a></div>":$.each(f,function(a,b){d+='<div class="col-sm-6"><a class="chooselabel" href="javascript:;" label="'+a+'" style="color:#707070;"><span class="checkbox"></span>'+b.name+"</a></div>"})}),a.content(['<form class="form-horizontal required-validate" onsubmit="return false;">','<div class="form-group">','<label class="col-sm-2 control-label">关系类型</label>','<div class="col-sm-9">'+d+"</div>","</div>",'<div class="form-group">','<label class="col-sm-2 control-label">推演跳数</label>','<div class="col-sm-9">','<select name="hop" style="width:100%;">',"<option>1</option>","<option>2</option>",'<option selected="selected">3</option>',"<option>4</option>","</select>","</div>","</div>",'<div class="form-group">','<label class="col-sm-2 control-label">关键字</label>','<div class="col-sm-9">','<input type="text" name="keyword" class="form-control" placeholder="请填写...">',"</div>","</div>","</form>"].join("")),$(".chooselabel",b).on("click",function(){var a=$(this);a.add($(".checkbox",a)).toggleClass("active")}),$(".chooseall",b).on("click",function(){var a=$(this);a.toggleClass("active"),a.hasClass("active")?$(".chooselabel,.checkbox",b).addClass("active"):$(".chooselabel,.checkbox",b).removeClass("active")}),$("select",b).select2()},okValue:"确定",ok:function(){var b=$(this.node),c=$("[name=hop]",b).val(),d=[],e=$("[name=keyword]",b).val();$(".chooselabel.active",b).each(function(){d.push($(this).attr("label"))}),d.length<1&&$(".chooselabel",b).each(function(){d.push($(this).attr("label"))}),d.length==$(".chooselabel",b).size()&&(d=[]),v(a,d,c,e)},cancelValue:"取消",cancel:!0,onclose:function(){$(".main").removeClass("blur")}}).showModal()},x=function(){var a=[],d=[],f=[];$.each(i.$("node.event:selected"),function(a,b){d.push(b.data().data)}),$.each(i.$("node.entity:selected"),function(b,c){var d=c.data().data;a.push(mining.mappingutils.getProperties(d,"key").value),f.push(d)});try{clearTimeout(e)}catch(g){}e=setTimeout(mining.utils.modalLoading,l),$ajax.ajax({url:h.merge,type:"POST",data:{ids:JSON.stringify(a),events:JSON.stringify(d),rules:JSON.stringify(j)},success:function(a){try{clearTimeout(e),mining.utils.modalLoading("close")}catch(d){}var g={e:a.hits.events,v:a.v,hits:{events:a.e,pairs:a.hits.pairs}};return!g.hits.pairs&&a.hits.length&&(g.e=a.hits[0].events,g.hits.pairs=a.hits[0].pairs),mining.utils.isEmpty(g.hits.pairs)&&mining.utils.isEmpty(g.e)?($dialog.alert("未找到任何数据！","warning"),void 0):(b.appenddata(mining.utils.frmatMergeData(g)),c.appenddata(f,g.hits.events,g.v),void 0)},error:function(a){try{clearTimeout(e),mining.utils.modalLoading("close")}catch(b){}mining.utils.alertMsg(a,"获取数据失败，请稍后重试！","error")}})},y=function(a){var b,c="",d=[],e=1;switch($.each(i.$("node.entity:selected,node.event:selected"),function(a,b){var c=mining.utils.clone(b.data().data);d.push(c)}),$.each(i.$("edge.relation:selected"),function(a,b){d.push($.extend(b.data().data,{source:b.source().data().data,target:b.target().data().data}))}),a){case"map":c=mining.localname.mapSnapshot,b=mining.utils.localStorage(c)||[];break;case"file":c=mining.localname.fileSnapshot,b=[]}$.each(d,function(c,d){"file"==a?(d.etype||(d.etype=mining.mappingutils.getType(d)),("doc"==d.label||"media"==d.label&&"doc"==d.type)&&(e=3),b.push(d)):b.pushOnly(d)}),"file"==a?mining.utils.updateFileData("add",{dataArr:b,tabType:e}):mining.utils.localStorage(c,b),mining.utils.hashChange(a)},z=function(){var a=[];$.each(i.$("node.entity:selected"),function(b,c){var d=c.data().data;"phoneNO"==d.label&&a.pushOnly(d.key)}),mining.utils.judgedDataByPhones(a)};return{init:m,expandEntity:p,expandRelation:v}});
